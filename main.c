#include <reg51.h>
#include <INTRINS.H>
#include "pca.h"
#include "relay.h"     // åŒ…å«ç»§ç”µå™¨æ§åˆ¶å¤´æ–‡ä»¶
#include "wavegen.h"   // åŒ…å«æ–¹æ³¢å‘ç”Ÿå™¨å¤´æ–‡ä»¶
#include "flowmeter.h" // åŒ…å«æµé‡è®¡å¤´æ–‡ä»¶
#include "uart.h"      // æ·»åŠ ä¸²å£é€šä¿¡å¤´æ–‡ä»¶
#include "keyboard_control.h"  // æ·»åŠ æŒ‰é”®æ§åˆ¶å¤´æ–‡ä»¶
#include "i2c.h"      // æ·»åŠ I2Cå¤´æ–‡ä»¶

#define multiplier 1.085

// ç³»ç»ŸçŠ¶æ€å®šä¹‰
#define SYS_STATE_OFF      0  // ç³»ç»Ÿå…³é—­
#define SYS_STATE_WATERING 1  // ç³»ç»Ÿæµ‡æ°´ä¸­
#define SYS_STATE_SET_HOUR 2  // è®¾ç½®å°æ—¶
#define SYS_STATE_SET_MIN  3  // è®¾ç½®åˆ†é’Ÿ
#define SYS_STATE_SET_SEC  4  // è®¾ç½®ç§’

// å½“å‰ç³»ç»ŸçŠ¶æ€
BYTE sysState = SYS_STATE_OFF;

// æŒ‰é”®å’Œæµ‡æ°´æ§åˆ¶ç›¸å…³å˜é‡
sbit KEY = P3^3;            // æŒ‰é”®è¿æ¥åˆ°P3.3
bit keyPressed = 0;         // æŒ‰é”®æŒ‰ä¸‹æ ‡å¿—
bit justEnteredSetMode = 0; // æ ‡å¿—æ˜¯å¦åˆšåˆšè¿›å…¥è®¾ç½®æ¨¡å¼
unsigned int keyPressTime = 0; // æŒ‰é”®æŒ‰ä¸‹æŒç»­æ—¶é—´ï¼ˆä»¥10msä¸ºå•ä½ï¼‰
#define LONG_PRESS_TIME 500   // é•¿æŒ‰æ—¶é—´é˜ˆå€¼ï¼ˆçº¦1ç§’ï¼‰

// æŒ‰é”®å¤„ç†å‡½æ•°
void processKey() {
    if (KEY == 0 && !keyPressed) {
        keyPressed = 1;
        keyPressTime = 0;
    } 
    else if (KEY == 0 && keyPressed) {
        keyPressTime++;
        
        if (keyPressTime == LONG_PRESS_TIME && sysState == SYS_STATE_OFF) {
            sysState = SYS_STATE_SET_HOUR;
            PCA_SetTimeEditMode(sysState - SYS_STATE_SET_HOUR + 1);
            justEnteredSetMode = 1;
        }
    }
    else if (KEY == 1 && keyPressed) {
        if (keyPressTime < LONG_PRESS_TIME) {
            switch (sysState) {
                case SYS_STATE_OFF:
                    // æ£€æŸ¥æ˜¯å¦å®šæ—¶æµ‡æ°´æ­£åœ¨è¿è¡Œ
                    if(!timed_watering.enabled) {
                        sysState = SYS_STATE_WATERING;
                        Relay_On();
                        FlowMeter_Reset();
                        FlowMeter_Start();
                        FlowMeter_SetMode(FLOW_MODE_CURR);
                        FlowMeter_UpdateDisplay();
                        auto_display_mode = DISPLAY_MODE_CLOCK; // æ‰‹åŠ¨æµ‡æ°´æ—¶æ˜¾ç¤ºæ—¶é’Ÿ
                    }
                    break;
                    
                case SYS_STATE_WATERING:
                    sysState = SYS_STATE_OFF;
                    Relay_Off();
                    FlowMeter_Stop();
                    FlowMeter_SetMode(FLOW_MODE_OFF);
                    break;
                    
                case SYS_STATE_SET_HOUR:
                    PCA_IncreaseTimeValue(HOUR_POS);
                    break;
                    
                case SYS_STATE_SET_MIN:
                    PCA_IncreaseTimeValue(MIN_POS);
                    break;
                    
                case SYS_STATE_SET_SEC:
                    PCA_IncreaseTimeValue(SEC_POS);
                    break;
            }
        } 
        else if (keyPressTime >= LONG_PRESS_TIME) {
            if (justEnteredSetMode) {
                justEnteredSetMode = 0;
            }
            else if (sysState >= SYS_STATE_SET_HOUR && sysState <= SYS_STATE_SET_SEC) {
                sysState++;
                
                if (sysState > SYS_STATE_SET_SEC) {
                    sysState = SYS_STATE_OFF;
                    PCA_ExitTimeEditMode();
                } else {
                    PCA_SetTimeEditMode(sysState - SYS_STATE_SET_HOUR + 1);
                }
            }
        }
        
        keyPressed = 0;
        keyPressTime = 0;
        delay_ms(20);
    }
}

void main(void) {
    EA = 1;
    P0 = 0xFF;
    
    /* 
     * ========================================
     * æ™ºèƒ½æµ‡èŠ±ç³»ç»Ÿ - å®šæ—¶å®šé‡æµ‡æ°´åŠŸèƒ½
     * ========================================
     * 
     * ã€ç³»ç»Ÿç‰¹ç‚¹ã€‘
     * ============
     * âœ“ ç²¾ç¡®æ—¶é—´æ§åˆ¶ï¼šå¯è®¾å®šæ¯å¤©å›ºå®šæ—¶é—´è‡ªåŠ¨æµ‡æ°´
     * âœ“ å®šé‡æµ‡æ°´ï¼šæŒ‰æ¯«å‡æ•°ç²¾ç¡®æ§åˆ¶æµ‡æ°´é‡
     * âœ“ æ•°æ®ä¿å­˜ï¼šç´¯è®¡æµé‡æ‰ç”µä¸ä¸¢å¤±
     * âœ“ æ™ºèƒ½é˜²é‡ï¼šæ¯å¤©åªæ‰§è¡Œä¸€æ¬¡ï¼Œé¿å…é‡å¤æµ‡æ°´
     * âœ“ æ‰‹åŠ¨æ§åˆ¶ï¼šæ”¯æŒæ‰‹åŠ¨ç«‹å³æµ‡æ°´
     * âœ“ ä¸²å£è®¾ç½®ï¼šæ”¯æŒé€šè¿‡ä¸²å£è®¾ç½®ç³»ç»Ÿæ—¶é—´
     * 
     * ã€ç¡¬ä»¶è¿æ¥ã€‘
     * ============
     * æ§åˆ¶éƒ¨åˆ†ï¼š
     * - P1.1: ç»§ç”µå™¨æ§åˆ¶ (ä½ç”µå¹³è§¦å‘)
     * - P1.0: æ–¹æ³¢å‘ç”Ÿå™¨è¾“å‡º (5Hzè„‰å†²ä¿¡å·)
     * - P3.2: INT0ä¸­æ–­è¾“å…¥ (æµé‡è®¡è„‰å†²è®¡æ•°)
     * 
     * æŒ‰é”®è¾“å…¥ï¼š
     * - P1.2: å¯åŠ¨/åœæ­¢å®šæ—¶æµ‡æ°´
     * - P1.3: å¢åŠ å‚æ•°å€¼
     * - P1.4: å‡å°‘å‚æ•°å€¼  
     * - P1.7: åˆ‡æ¢è®¾ç½®æ¨¡å¼
     * - P3.3: æ‰‹åŠ¨æµ‡æ°´/æ—¶é—´è®¾ç½®
     * 
     * å­˜å‚¨è®¾å¤‡ï¼š
     * - P2.0: I2Cæ•°æ®çº¿SDA (è¿æ¥24C02)
     * - P2.1: I2Cæ—¶é’Ÿçº¿SCL (è¿æ¥24C02)
     * 
     * ã€å¿«é€Ÿä½¿ç”¨æŒ‡å—ã€‘
     * ================
     * 
     * ğŸ• ç¬¬ä¸€æ­¥ï¼šè®¾ç½®æµ‡æ°´æ—¶é—´
     *    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     *    â”‚ 1. æŒ‰P1.7 â†’ æ•°ç ç®¡æ˜¾ç¤º"HH0002"      â”‚
     *    â”‚    ç”¨P1.3/P1.4è®¾ç½®å°æ—¶(0-23)       â”‚
     *    â”‚ 2. æŒ‰P1.7 â†’ æ•°ç ç®¡æ˜¾ç¤º"MM0003"      â”‚
     *    â”‚    ç”¨P1.3/P1.4è®¾ç½®åˆ†é’Ÿ(0-59)       â”‚
     *    â”‚ 3. æŒ‰P1.7 â†’ æ•°ç ç®¡æ˜¾ç¤º"SS0001"      â”‚
     *    â”‚    ç”¨P1.3/P1.4è®¾ç½®ç§’(0-59)         â”‚
     *    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     * 
     * ğŸ’§ ç¬¬äºŒæ­¥ï¼šè®¾ç½®æµ‡æ°´é‡
     *    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     *    â”‚ 4. æŒ‰P1.7 â†’ æ•°ç ç®¡æ˜¾ç¤º"MMMM05"      â”‚
     *    â”‚    ç”¨P1.3/P1.4è®¾ç½®æ¯«å‡æ•°            â”‚
     *    â”‚    (50-9999mlï¼Œæ­¥é•¿50ml)            â”‚
     *    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     * 
     * â–¶ï¸ ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨å®šæ—¶æµ‡æ°´
     *    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     *    â”‚ 5. æŒ‰P1.2å¯åŠ¨å®šæ—¶æµ‡æ°´åŠŸèƒ½           â”‚
     *    â”‚    ç³»ç»Ÿè¿›å…¥è‡ªåŠ¨æ¨¡å¼ï¼Œç­‰å¾…è®¾å®šæ—¶é—´    â”‚
     *    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     * 
     * ã€æ•°ç ç®¡æ˜¾ç¤ºè¯´æ˜ã€‘
     * ==================
     * 
     * æ—¶é’Ÿæ¨¡å¼ï¼šæ˜¾ç¤ºå½“å‰æ—¶é—´ "HHMMSS"
     * ä¾‹å¦‚ï¼š145023 = 14:50:23
     * 
     * å‚æ•°è®¾ç½®æ¨¡å¼ï¼š
     * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     * â”‚ æ˜¾ç¤ºæ ¼å¼  â”‚    å«ä¹‰     â”‚    ç¤ºä¾‹      â”‚
     * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     * â”‚ HH0003   â”‚  è®¾ç½®å°æ—¶   â”‚ 060003=6ç‚¹   â”‚
     * â”‚ MM0002   â”‚  è®¾ç½®åˆ†é’Ÿ   â”‚ 300002=30åˆ†  â”‚
     * â”‚ SS0001   â”‚  è®¾ç½®ç§’     â”‚ 450001=45ç§’  â”‚
     * â”‚ MMMM05   â”‚  è®¾ç½®æ¯«å‡   â”‚ 150005=150ml â”‚
     * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     * 
     * æµ‡æ°´çŠ¶æ€ï¼š
     * - ç­‰å¾…æµ‡æ°´ï¼šå‚æ•°é—ªçƒæ˜¾ç¤º
     * - æ­£åœ¨æµ‡æ°´ï¼šæ˜¾ç¤ºå‰©ä½™æ¯«å‡æ•° "XXXX05"
     * - æµ‡æ°´å®Œæˆï¼šè¿”å›æ—¶é’Ÿæ˜¾ç¤º
     * 
     * ã€å®é™…ä½¿ç”¨ä¾‹å­ã€‘
     * ================
     * 
     * ğŸŒ± åœºæ™¯1ï¼šæ¯å¤©æ—©ä¸Š7ç‚¹æµ‡150æ¯«å‡æ°´
     * æ­¥éª¤ï¼š
     * 1. P1.7 â†’ è®¾ç½®"070003" (7ç‚¹)
     * 2. P1.7 â†’ è®¾ç½®"000002" (0åˆ†) 
     * 3. P1.7 â†’ è®¾ç½®"000001" (0ç§’)
     * 4. P1.7 â†’ è®¾ç½®"150005" (150æ¯«å‡)
     * 5. P1.2 â†’ å¯åŠ¨å®šæ—¶æµ‡æ°´
     * ç»“æœï¼šæ¯å¤©7:00:00è‡ªåŠ¨æµ‡æ°´150æ¯«å‡
     * 
     * ğŸŒ± åœºæ™¯2ï¼šå‚æ™š6ç‚¹åŠæµ‡100æ¯«å‡æ°´  
     * æ­¥éª¤ï¼š
     * 1. P1.7 â†’ è®¾ç½®"180003" (18ç‚¹)
     * 2. P1.7 â†’ è®¾ç½®"300002" (30åˆ†)
     * 3. P1.7 â†’ è®¾ç½®"000001" (0ç§’) 
     * 4. P1.7 â†’ è®¾ç½®"100005" (100æ¯«å‡)
     * 5. P1.2 â†’ å¯åŠ¨å®šæ—¶æµ‡æ°´
     * ç»“æœï¼šæ¯å¤©18:30:00è‡ªåŠ¨æµ‡æ°´100æ¯«å‡
     * 
     * ã€æ•…éšœå¤„ç†ã€‘
     * ============
     * 
     * Q: è®¾ç½®æ—¶é—´åä¸æµ‡æ°´ï¼Ÿ
     * A: æ£€æŸ¥æ˜¯å¦æŒ‰P1.2å¯åŠ¨å®šæ—¶åŠŸèƒ½
     * 
     * Q: æµ‡æ°´é‡ä¸å‡†ç¡®ï¼Ÿ
     * A: æ£€æŸ¥æµé‡è®¡è¿æ¥å’Œæ–¹æ³¢å‘ç”Ÿå™¨é¢‘ç‡
     * 
     * Q: æ–­ç”µåç´¯è®¡æµé‡ä¸¢å¤±ï¼Ÿ
     * A: æ£€æŸ¥24C02è¿æ¥å’ŒI2Cé€šä¿¡
     * 
     * Q: æ¯å¤©æµ‡æ°´å¤šæ¬¡ï¼Ÿ
     * A: ç³»ç»Ÿè®¾è®¡ä¸ºæ¯å¤©åªæµ‡ä¸€æ¬¡ï¼Œå¦‚å‡ºç°è¯·æ£€æŸ¥æ—¶é’Ÿ
     */
    
    PCA_Init();
    Relay_Init();
    WaveGen_Init();
    WaveGen_Start();
    FlowMeter_Init();
    UART_Init();
    KeyboardControl_Init();  // åˆå§‹åŒ–æŒ‰é”®æ§åˆ¶
    
    // å‘é€å¯åŠ¨ä¿¡æ¯åˆ°ä¸²å£
    UART_SendString("\r\næµ‡èŠ±ç³»ç»Ÿå·²å¯åŠ¨\r\n");
    UART_SendString("å½“å‰æ—¶é—´è®¾ç½®åŠŸèƒ½å¯ç”¨\r\n");
    UART_SendString("å®šæ—¶æµ‡æ°´åŠŸèƒ½å·²åˆå§‹åŒ–\r\n");
    
    while (1) {
        processKey();
        KeyboardControl_Scan();
        CheckAndUpdateAutoDisplay();
        FlowMeter_UpdateDisplay();
        UART_ProcessCommand();
        
        // æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰- æ³¨é‡Šæ‰ä»¥é¿å…é¢‘ç¹è¾“å‡º
        /*
        static BYTE debug_counter = 0;
        if(++debug_counter >= 100) {  // æ¯1ç§’è¾“å‡ºä¸€æ¬¡çŠ¶æ€
            debug_counter = 0;
            if(timed_watering.enabled) {
                UART_SendString("å®šæ—¶æµ‡æ°´å·²å¯ç”¨ï¼Œç­‰å¾…æ—¶é—´: ");
                // å‘é€å½“å‰æ—¶é—´å’Œè®¾å®šæ—¶é—´
            }
        }
        */
        
        delay_ms(10);
    }
}