# 🌻 基于51单片机的智能浇水系统

[![Platform](https://img.shields.io/badge/Platform-STC89C52-blue.svg)](http://www.stcmcudata.com/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

## 📖 项目简介

本项目是一个基于STC89C52单片机的智能浇水系统，具备自动定时浇水、手动浇水控制、流量检测与记录、实时时钟显示、参数设置等功能。系统采用模块化设计，通过多种外设协同工作，实现了完整的智能控制功能。

## ✨ 功能特点

### 🚿 浇水控制
- **自动定时浇水**：设定时间自动启动，达到设定流量自动停止
- **手动浇水控制**：按键启动/停止，实时显示流量
- **冲突处理**：手动与自动模式互斥，避免重复操作

### 💧 流量检测
- **实时流量显示**：当前流量（毫升/秒）
- **累计流量统计**：总流量记录，支持7位数值（最大9999999毫升）
- **数据保护**：EEPROM存储，断电数据不丢失

### ⏰ 时间系统
- **完整日期时间**：年月日时分秒显示（2000-2099年）
- **闰年自动处理**：正确处理2月29日
- **自动轮换显示**：时间⇄日期每5秒自动切换

### 📺 8位数码管显示
- **时间格式**：`HH-MM-SS`（8位全显示）
- **日期格式**：`YYYYMMDD`（8位全显示）
- **流量格式**：`XXXXXXX10/11`（7位数值+模式标识）
- **参数格式**：`XXXXXXXA/B/c/d`（7位数值+字母标识）

### 🔧 串口通信
- **远程控制**：通过串口设置时间、日期、浇水参数
- **状态监控**：实时输出系统状态和浇水记录
- **波特率**：9600bps

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────┐
│                    STC89C52                         │
├─────────────────────────────────────────────────────┤
│  P1.0 ──→ 方波发生器(T0) ──→ 继电器 ──→ INT0       │
│  P1.1 ──→ 继电器控制（水阀）                        │
│  P1.2-P1.7 ──→ 多功能按键                           │
│  P2.0-P2.7 ──→ 74HC595 ──→ 8位数码管               │
│  P2.5-P2.6 ──→ I2C ──→ AT24C02 EEPROM             │
│  P3.2(INT0) ──→ 流量脉冲检测                        │
│  P3.3 ──→ 系统主按键                               │
│  P3.0/P3.1 ──→ 串口通信(UART)                      │
└─────────────────────────────────────────────────────┘
```

## 📁 项目结构

```
51_FlowerWateringSimulator/
├── main.c                 # 主程序（系统调度）
├── pca.c / pca.h         # PCA时钟系统和显示控制
├── flowmeter.c / flowmeter.h    # 流量检测模块
├── keyboard_control.c / keyboard_control.h  # 按键控制模块
├── uart.c / uart.h       # 串口通信模块
├── relay.c / relay.h     # 继电器控制模块
├── wavegen.c / wavegen.h # 方波发生器模块
├── i2c.c / i2c.h         # I2C通信和EEPROM存储
├── Project.uvproj        # Keil uVision工程文件
├── Objects/              # 编译输出目录
├── Listings/             # 列表文件目录
└── README.md             # 项目说明文档
```

## 🔧 硬件配置

### 主要元器件
| 器件 | 型号 | 功能 |
|------|------|------|
| 单片机 | STC89C52 | 主控制器 |
| 晶振 | 11.0592MHz | 系统时钟 |
| 数码管 | 8位共阴极 | 显示输出 |
| 移位寄存器 | 74HC595×2 | 数码管驱动 |
| EEPROM | AT24C02 | 数据存储 |
| 继电器模块 | 5V低电平触发 | 水阀控制 |

### 引脚分配
| 引脚 | 功能 | 说明 |
|------|------|------|
| P1.0 | WAVE_OUT | 方波信号输出 |
| P1.1 | RELAY | 继电器控制 |
| P2.5 | SDA | I2C数据线 |
| P2.6 | SCL | I2C时钟线 |
| P3.2 | INT0 | 流量脉冲输入 |
| P3.3 | KEY | 系统主按键 |
| P3.0/P3.1 | RXD/TXD | 串口通信 |

## 💻 软件设计

### 模块化架构
```
应用层：main.c（系统调度和状态机）
    ↓
功能层：keyboard_control.c, flowmeter.c, uart.c
    ↓
驱动层：pca.c, wavegen.c, relay.c, i2c.c
    ↓
硬件层：STC89C52 + 外设
```

### 中断资源分配
| 中断源 | 优先级 | 功能 |
|--------|--------|------|
| PCA | 高 | 时钟计时 + 显示扫描 |
| INT0 | 中 | 流量脉冲计数 |
| T0 | 中 | 方波信号生成 |
| UART | 低 | 串口数据接收 |

### 核心算法
- **方波生成**：T0定时50ms + 软件2分频 → 5Hz方波
- **流量计算**：1脉冲 = 1毫升，每秒统计脉冲数
- **时间管理**：PCA 100Hz中断驱动，支持闰年计算

## 📝 使用说明

### 按键操作

#### P3.3主按键
| 状态 | 短按 | 长按（>1秒） |
|------|------|--------------|
| 关闭状态 | 开始手动浇水 | 进入时间设置 |
| 浇水状态 | 停止浇水 | - |
| 设置状态 | 增加数值 | 切换设置项 |

#### 多功能按键（P1.2-P1.7）
| 按键 | 功能 |
|------|------|
| KEY_AUTO | 启动/停止自动浇水 |
| KEY_MODE | 切换参数设置模式 |
| KEY_TIME_UP | 时间参数增加 |
| KEY_TIME_DOWN | 时间参数减少 |
| KEY_VOL_UP | 流量参数增加 |
| KEY_VOL_DOWN | 流量参数减少 |

### 串口命令
```bash
# 设置时间（格式：TIME:HH:MM:SS）
TIME:12:30:00

# 设置日期（格式：DATE:YYYY:MM:DD）
DATE:2025:11:28

# 设置自动浇水（格式：A:HH:MM:SS:MMMM）
A:08:00:00:0500    # 每天8点浇水500毫升

# 切换显示模式
DISPTIME           # 显示时间
DISPDATE           # 显示日期

# 停止自动浇水
STOP
```

### 显示模式标识
| 标识 | 含义 |
|------|------|
| 10 | 当前流量模式 |
| 11 | 累计流量模式 |
| A | 秒设置模式 |
| B | 分钟设置模式 |
| c | 小时设置模式 |
| d | 毫升设置模式 |

## 🛠️ 编译与下载

### 开发环境
- **IDE**：Keil uVision 5
- **编译器**：C51
- **下载工具**：STC-ISP

### 编译步骤
1. 使用Keil uVision打开 `Project.uvproj`
2. 点击 `Build` 或按 `F7` 编译项目
3. 编译成功后在 `Objects/` 目录生成HEX文件

### 下载步骤
1. 打开STC-ISP下载软件
2. 选择单片机型号：STC89C52RC
3. 选择串口和波特率
4. 加载HEX文件
5. 点击下载，给单片机上电

## 📊 技术指标

| 指标 | 参数 |
|------|------|
| 工作电压 | 5V DC |
| 时钟精度 | ±1秒/小时 |
| 流量范围 | 0-9999999毫升 |
| 流量精度 | 1毫升/脉冲 |
| 存储容量 | 256字节(AT24C02) |
| 串口波特率 | 9600bps |
| 显示位数 | 8位数码管 |

## 🎯 应用场景

- 🏠 家庭花卉自动浇水
- 🌱 小型温室灌溉控制
- 🔬 实验室定量给液系统
- 📚 嵌入式系统教学演示

## 👨‍💻 作者

**Sakurapainting**

## 📄 许可证

本项目采用 MIT 许可证 - 详情请查看 [LICENSE](LICENSE) 文件

---

⭐ 如果这个项目对你有帮助，请给它一个Star！
