C51 COMPILER V9.54   MAIN                                                                  05/27/2025 21:55:53 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\Keil5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main.l
                    -st) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <reg51.h>
   2          #include <INTRINS.H>
   3          #include "pca.h"
   4          #include "relay.h"     // 包含继电器控制头文件
   5          #include "wavegen.h"   // 包含方波发生器头文件
   6          #include "flowmeter.h" // 包含流量计头文件
   7          #include "uart.h"      // 添加串口通信头文件
   8          #include "keyboard_control.h"  // 添加按键控制头文件
   9          #include "i2c.h"      // 添加I2C头文件
  10          
  11          #define multiplier 1.085
  12          
  13          // 系统状态定义 - 扩展支持年月日设置
  14          #define SYS_STATE_OFF      0  // 系统关闭
  15          #define SYS_STATE_WATERING 1  // 系统浇水中
  16          #define SYS_STATE_SET_YEAR 2  // 设置年份
  17          #define SYS_STATE_SET_MONTH 3 // 设置月份
  18          #define SYS_STATE_SET_DAY  4  // 设置日期
  19          #define SYS_STATE_SET_HOUR 5  // 设置小时
  20          #define SYS_STATE_SET_MIN  6  // 设置分钟
  21          #define SYS_STATE_SET_SEC  7  // 设置秒
  22          
  23          // 当前系统状态
  24          BYTE sysState = SYS_STATE_OFF;
  25          
  26          // 按键和浇水控制相关变量
  27          sbit KEY = P3^3;            // 按键连接到P3.3
  28          bit keyPressed = 0;         // 按键按下标志
  29          bit justEnteredSetMode = 0; // 标志是否刚刚进入设置模式
  30          unsigned int xdata keyPressTime = 0; // 按键按下持续时间（以10ms为单位）
  31          #define LONG_PRESS_TIME 100   // 长按时间阈值（约1秒，调整为合理值）
  32          
  33          // 按键处理函数
  34          void processKey() {
  35   1          if (KEY == 0 && !keyPressed) {
  36   2              keyPressed = 1;
  37   2              keyPressTime = 0;
  38   2          } 
  39   1          else if (KEY == 0 && keyPressed) {
  40   2              keyPressTime++;
  41   2              
  42   2              // 长按进入设置模式，从年份开始设置
  43   2              if (keyPressTime == LONG_PRESS_TIME && sysState == SYS_STATE_OFF) {
  44   3                  sysState = SYS_STATE_SET_YEAR;
  45   3                  PCA_SetTimeEditMode(YEAR_POS);
  46   3                  PCA_SetDisplayMode(DISPLAY_DATE_MODE);  // 切换到日期显示模式
  47   3                  PCA_ResetAutoToggle();  // 重置自动轮换计数器
  48   3                  justEnteredSetMode = 1;
  49   3              }
  50   2          }
  51   1          else if (KEY == 1 && keyPressed) {
  52   2              if (keyPressTime < LONG_PRESS_TIME) {
  53   3                  // 短按：根据当前状态增加对应的数值
  54   3                  switch (sysState) {
C51 COMPILER V9.54   MAIN                                                                  05/27/2025 21:55:53 PAGE 2   

  55   4                      case SYS_STATE_OFF:
  56   4                          // 检查是否定时浇水正在运行
  57   4                          if(!timed_watering.enabled || !timed_watering.is_watering) {
  58   5                              sysState = SYS_STATE_WATERING;
  59   5                              
  60   5                              // 开始手动浇水记录 - 优化后无需传参
  61   5                              StartManualWateringRecord();
  62   5                              
  63   5                              Relay_On();
  64   5                              FlowMeter_Reset();
  65   5                              FlowMeter_Start();
  66   5                              FlowMeter_SetMode(FLOW_MODE_CURR);
  67   5                              FlowMeter_UpdateDisplay();
  68   5                              auto_display_mode = DISPLAY_MODE_CLOCK; // 手动浇水时显示时钟
  69   5                          }
  70   4                          break;
  71   4                          
  72   4                      case SYS_STATE_WATERING:
  73   4                          sysState = SYS_STATE_OFF;
  74   4                          Relay_Off();
  75   4                          FlowMeter_Stop();
  76   4                          FlowMeter_SetMode(FLOW_MODE_OFF);
  77   4                          
  78   4                          // 结束手动浇水记录 - 优化后无需传参
  79   4                          EndManualWateringRecord();
  80   4                          break;
  81   4                          
  82   4                      case SYS_STATE_SET_YEAR:
  83   4                          PCA_IncreaseTimeValue(YEAR_POS);
  84   4                          break;
  85   4                          
  86   4                      case SYS_STATE_SET_MONTH:
  87   4                          PCA_IncreaseTimeValue(MONTH_POS);
  88   4                          break;
  89   4                          
  90   4                      case SYS_STATE_SET_DAY:
  91   4                          PCA_IncreaseTimeValue(DAY_POS);
  92   4                          break;
  93   4                          
  94   4                      case SYS_STATE_SET_HOUR:
  95   4                          PCA_IncreaseTimeValue(HOUR_POS);
  96   4                          break;
  97   4                          
  98   4                      case SYS_STATE_SET_MIN:
  99   4                          PCA_IncreaseTimeValue(MIN_POS);
 100   4                          break;
 101   4                          
 102   4                      case SYS_STATE_SET_SEC:
 103   4                          PCA_IncreaseTimeValue(SEC_POS);
 104   4                          break;
 105   4                  }
 106   3              } 
 107   2              else if (keyPressTime >= LONG_PRESS_TIME) {
 108   3                  // 长按：切换到下一项设置
 109   3                  if (justEnteredSetMode) {
 110   4                      justEnteredSetMode = 0;
 111   4                  }
 112   3                  else if (sysState >= SYS_STATE_SET_YEAR && sysState <= SYS_STATE_SET_SEC) {
 113   4                      sysState++;
 114   4                      
 115   4                      // 设置完所有参数后退出设置模式
 116   4                      if (sysState > SYS_STATE_SET_SEC) {
C51 COMPILER V9.54   MAIN                                                                  05/27/2025 21:55:53 PAGE 3   

 117   5                          sysState = SYS_STATE_OFF;
 118   5                          PCA_ExitTimeEditMode();
 119   5                          // 恢复到时间显示模式并重置自动轮换
 120   5                          PCA_SetDisplayMode(DISPLAY_TIME_MODE);
 121   5                          PCA_ResetAutoToggle();
 122   5                      } else {
 123   5                          // 根据当前设置状态切换显示模式和编辑位置
 124   5                          switch(sysState) {
 125   6                              case SYS_STATE_SET_YEAR:
 126   6                                  PCA_SetTimeEditMode(YEAR_POS);
 127   6                                  PCA_SetDisplayMode(DISPLAY_DATE_MODE);
 128   6                                  break;
 129   6                              case SYS_STATE_SET_MONTH:
 130   6                                  PCA_SetTimeEditMode(MONTH_POS);
 131   6                                  PCA_SetDisplayMode(DISPLAY_DATE_MODE);
 132   6                                  break;
 133   6                              case SYS_STATE_SET_DAY:
 134   6                                  PCA_SetTimeEditMode(DAY_POS);
 135   6                                  PCA_SetDisplayMode(DISPLAY_DATE_MODE);
 136   6                                  break;
 137   6                              case SYS_STATE_SET_HOUR:
 138   6                                  PCA_SetTimeEditMode(HOUR_POS);
 139   6                                  PCA_SetDisplayMode(DISPLAY_TIME_MODE);  // 切换到时间显示模式
 140   6                                  break;
 141   6                              case SYS_STATE_SET_MIN:
 142   6                                  PCA_SetTimeEditMode(MIN_POS);
 143   6                                  PCA_SetDisplayMode(DISPLAY_TIME_MODE);
 144   6                                  break;
 145   6                              case SYS_STATE_SET_SEC:
 146   6                                  PCA_SetTimeEditMode(SEC_POS);
 147   6                                  PCA_SetDisplayMode(DISPLAY_TIME_MODE);
 148   6                                  break;
 149   6                          }
 150   5                      }
 151   4                  }
 152   3              }
 153   2              
 154   2              keyPressed = 0;
 155   2              keyPressTime = 0;
 156   2              delay_ms(20);
 157   2          }
 158   1      }
 159          
 160          void main(void) {
 161   1          EA = 1;
 162   1          P0 = 0xFF;
 163   1          
 164   1          /* 
 165   1           * ========================================
 166   1           * 智能浇花系统 - P3.3按键时间设置功能 (8位数码管版本)
 167   1           * ========================================
 168   1           * 
 169   1           * 【P3.3按键操作说明】
 170   1           * ==================
 171   1           * 
 172   1           * 🔘 短按功能：
 173   1           *    - 正常模式：启动/停止手动浇水
 174   1           *    - 设置模式：增加当前设置项的数值
 175   1           * 
 176   1           * 🔘 长按功能（约1秒）：
 177   1           *    - 正常模式：进入时间设置模式
 178   1           *    - 设置模式：切换到下一个设置项
C51 COMPILER V9.54   MAIN                                                                  05/27/2025 21:55:53 PAGE 4   

 179   1           * 
 180   1           * 【时间设置流程】
 181   1           * ================
 182   1           * 
 183   1           * 1️⃣ 长按P3.3 → 进入年份设置
 184   1           *    显示：日期模式 (YYYYMMDD)，全部8位数码管显示
 185   1           *    操作：短按P3.3增加年份 (2000-2099)
 186   1           *    闪烁：左侧4位年份数字闪烁
 187   1           * 
 188   1           * 2️⃣ 长按P3.3 → 切换到月份设置
 189   1           *    显示：日期模式 (YYYYMMDD)，全部8位数码管显示
 190   1           *    操作：短按P3.3增加月份 (1-12)
 191   1           *    闪烁：中间2位月份数字闪烁
 192   1           * 
 193   1           * 3️⃣ 长按P3.3 → 切换到日期设置
 194   1           *    显示：日期模式 (YYYYMMDD)，全部8位数码管显示
 195   1           *    操作：短按P3.3增加日期 (1-31，自动适应月份)
 196   1           *    闪烁：右侧2位日期数字闪烁
 197   1           * 
 198   1           * 4️⃣ 长按P3.3 → 切换到小时设置
 199   1           *    显示：时间模式 (HHMMSS)，右侧6位数码管显示
 200   1           *    操作：短按P3.3增加小时 (0-23)
 201   1           *    闪烁：小时位闪烁，左侧2位关闭
 202   1           * 
 203   1           * 5️⃣ 长按P3.3 → 切换到分钟设置
 204   1           *    显示：时间模式 (HHMMSS)，右侧6位数码管显示
 205   1           *    操作：短按P3.3增加分钟 (0-59)
 206   1           *    闪烁：分钟位闪烁，左侧2位关闭
 207   1           * 
 208   1           * 6️⃣ 长按P3.3 → 切换到秒设置
 209   1           *    显示：时间模式 (HHMMSS)，右侧6位数码管显示
 210   1           *    操作：短按P3.3增加秒 (0-59)
 211   1           *    闪烁：秒位闪烁，左侧2位关闭
 212   1           * 
 213   1           * 7️⃣ 长按P3.3 → 完成设置，退出设置模式
 214   1           *    显示：返回正常时间显示模式，自动轮换
 215   1           * 
 216   1           * 【显示模式说明】
 217   1           * ================
 218   1           * 
 219   1           * 日期设置时 (步骤1-3)：
 220   1           * ┌────────────────────────────────
             -─────┐
 221   1           * │ 数码管格式：YYYYMMDD (8位全显示)    │
 222   1           * │ 示例："20250527" = 2025年5月27日    │
 223   1           * │ 排列：2 0 2 5 0 5 2 7               │
 224   1           * │       ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑               │
 225   1           * │      千百十个月月日日                │
 226   1           * │       年年年年  份  期               │
 227   1           * │ 闪烁部分：当前正在设置的位          │
 228   1           * └────────────────────────────────
             -─────┘
 229   1           * 
 230   1           * 时间设置时 (步骤4-6)：
 231   1           * ┌────────────────────────────────
             -─────┐
 232   1           * │ 数码管格式：  HHMMSS (右侧6位)      │
 233   1           * │ 示例："  143025" = 14:30:25         │
 234   1           * │ 排列：⚫ ⚫ 1 4 3 0 2 5               │
 235   1           * │       ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑               │
 236   1           * │      关关时时分分秒秒                │
 237   1           * │      闭闭                           │
C51 COMPILER V9.54   MAIN                                                                  05/27/2025 21:55:53 PAGE 5   

 238   1           * │ 闪烁部分：当前正在设置的位          │
 239   1           * └────────────────────────────────
             -─────┘
 240   1           * 
 241   1           * 【正常运行显示】
 242   1           * ================
 243   1           * 
 244   1           * 自动轮换模式（每5秒切换）：
 245   1           * - 时间显示："  143025" (14:30:25)
 246   1           * - 日期显示："20250527" (2025年5月27日)
 247   1           * 
 248   1           * 【使用示例】
 249   1           * ============
 250   1           * 
 251   1           * 设置时间为 2025年12月25日 09:30:00：
 252   1           * 
 253   1           * 1. 长按P3.3进入设置 → 显示"20250101"，年份"2025"闪烁
 254   1           * 2. 短按P3.3将年份保持为2025 (或调整)
 255   1           * 3. 长按P3.3切换到月份 → 显示"20250101"，月份"01"闪烁
 256   1           * 4. 短按P3.3将月份调到12 → 显示"20251201"
 257   1           * 5. 长按P3.3切换到日期 → 显示"20251201"，日期"01"闪烁
 258   1           * 6. 短按P3.3将日期调到25 → 显示"20251225"
 259   1           * 7. 长按P3.3切换到小时 → 显示"  000000"，小时"00"闪烁
 260   1           * 8. 短按P3.3将小时调到09 → 显示"  090000"
 261   1           * 9. 长按P3.3切换到分钟 → 显示"  090000"，分钟"00"闪烁
 262   1           * 10. 短按P3.3将分钟调到30 → 显示"  093000"
 263   1           * 11. 长按P3.3切换到秒 → 显示"  093000"，秒"00"闪烁
 264   1           * 12. 保持秒为00
 265   1           * 13. 长按P3.3完成设置 → 退出设置模式，开始自动轮换显示
 266   1           * 
 267   1           * 【技术特点】
 268   1           * ============
 269   1           * 
 270   1           * ✓ 年份完整显示：显示完整4位年份 (2000-2099)
 271   1           * ✓ 8位数码管充分利用：日期显示使用全部8位
 272   1           * ✓ 时间显示节约：时间显示仅使用右侧6位，左侧2位关闭
 273   1           * ✓ 智能闪烁：编辑时相关位数闪烁，其他位保持显示
 274   1           * ✓ 自动轮换：正常运行时每5秒在时间和日期间切换
 275   1           * ✓ 闰年处理：2月份会自动适应28/29天
 276   1           * ✓ 日期校验：切换月份时会自动调整日期上限
 277   1           * 
 278   1           * 【注意事项】
 279   1           * ============
 280   1           * 
 281   1           * ⚠️ 显示区别：
 282   1           *   - 日期模式：8位全显示 (YYYYMMDD)
 283   1           *   - 时间模式：右6位显示 (  HHMMSS)
 284   1           * 
 285   1           * ⚠️ 闪烁提示：
 286   1           *   - 年份设置：左侧4位闪烁
 287   1           *   - 月份设置：中间2位闪烁 
 288   1           *   - 日期设置：右侧2位闪烁
 289   1           *   - 时分秒设置：对应2位闪烁
 290   1           * 
 291   1           * ⚠️ 年份范围：2000-2099，超出范围会循环
 292   1           * ⚠️ 设置连续性：必须按顺序设置，不可跳过
 293   1           */
 294   1          
 295   1          PCA_Init();
 296   1          Relay_Init();
 297   1          WaveGen_Init();
 298   1          WaveGen_Start();
C51 COMPILER V9.54   MAIN                                                                  05/27/2025 21:55:53 PAGE 6   

 299   1          UART_Init();
 300   1          I2C_Init();  
 301   1          FlowMeter_Init();
 302   1          KeyboardControl_Init();  // 初始化按键控制
 303   1          
 304   1          // 发送启动信息到串口
 305   1          UART_SendString("\r\nWatering System Started v4.0 (8-Digit Display)\r\n");
 306   1          UART_SendString("Auto Display: Time<->Date every 5 seconds\r\n");
 307   1          UART_SendString("Date Format: YYYYMMDD (8-digit full display)\r\n");
 308   1          UART_SendString("Time Format:   HHMMSS (6-digit right display)\r\n");
 309   1          UART_SendString("P3.3 Key: Long press to set date/time\r\n");
 310   1          UART_SendString("Setting order: Year->Month->Day->Hour->Min->Sec\r\n");
 311   1          
 312   1          while (1) {
 313   2              processKey();
 314   2              KeyboardControl_Scan();
 315   2              CheckAndUpdateAutoDisplay();
 316   2              FlowMeter_UpdateDisplay();
 317   2              UART_ProcessCommand();
 318   2              
 319   2              delay_ms(10);
 320   2          }
 321   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    490    ----
   CONSTANT SIZE    =    280    ----
   XDATA SIZE       =      2    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
