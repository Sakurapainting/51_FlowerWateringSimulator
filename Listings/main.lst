C51 COMPILER V9.54   MAIN                                                                  05/26/2025 21:55:47 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\Keil5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main.l
                    -st) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <reg51.h>
   2          #include <INTRINS.H>
   3          #include "pca.h"
   4          #include "relay.h"     // åŒ…å«ç»§ç”µå™¨æ§åˆ¶å¤´æ–‡ä»¶
   5          #include "wavegen.h"   // åŒ…å«æ–¹æ³¢å‘ç”Ÿå™¨å¤´æ–‡ä»¶
   6          #include "flowmeter.h" // åŒ…å«æµé‡è®¡å¤´æ–‡ä»¶
   7          #include "uart.h"      // æ·»åŠ ä¸²å£é€šä¿¡å¤´æ–‡ä»¶
   8          #include "keyboard_control.h"  // æ·»åŠ æŒ‰é”®æ§åˆ¶å¤´æ–‡ä»¶
   9          #include "i2c.h"      // æ·»åŠ I2Cå¤´æ–‡ä»¶
  10          
  11          #define multiplier 1.085
  12          
  13          // ç³»ç»ŸçŠ¶æ€å®šä¹‰
  14          #define SYS_STATE_OFF      0  // ç³»ç»Ÿå…³é—­
  15          #define SYS_STATE_WATERING 1  // ç³»ç»Ÿæµ‡æ°´ä¸­
  16          #define SYS_STATE_SET_HOUR 2  // è®¾ç½®å°æ—¶
  17          #define SYS_STATE_SET_MIN  3  // è®¾ç½®åˆ†é’Ÿ
  18          #define SYS_STATE_SET_SEC  4  // è®¾ç½®ç§’
  19          
  20          // å½“å‰ç³»ç»ŸçŠ¶æ€
  21          BYTE sysState = SYS_STATE_OFF;
  22          
  23          // æŒ‰é”®å’Œæµ‡æ°´æ§åˆ¶ç›¸å…³å˜é‡
  24          sbit KEY = P3^3;            // æŒ‰é”®è¿æ¥åˆ°P3.3
  25          bit keyPressed = 0;         // æŒ‰é”®æŒ‰ä¸‹æ ‡å¿—
  26          bit justEnteredSetMode = 0; // æ ‡å¿—æ˜¯å¦åˆšåˆšè¿›å…¥è®¾ç½®æ¨¡å¼
  27          unsigned int keyPressTime = 0; // æŒ‰é”®æŒ‰ä¸‹æŒç»­æ—¶é—´ï¼ˆä»¥10msä¸ºå•ä½ï¼‰
  28          #define LONG_PRESS_TIME 500   // é•¿æŒ‰æ—¶é—´é˜ˆå€¼ï¼ˆçº¦1ç§’ï¼‰
  29          
  30          // æŒ‰é”®å¤„ç†å‡½æ•°
  31          void processKey() {
  32   1          if (KEY == 0 && !keyPressed) {
  33   2              keyPressed = 1;
  34   2              keyPressTime = 0;
  35   2          } 
  36   1          else if (KEY == 0 && keyPressed) {
  37   2              keyPressTime++;
  38   2              
  39   2              if (keyPressTime == LONG_PRESS_TIME && sysState == SYS_STATE_OFF) {
  40   3                  sysState = SYS_STATE_SET_HOUR;
  41   3                  PCA_SetTimeEditMode(sysState - SYS_STATE_SET_HOUR + 1);
  42   3                  justEnteredSetMode = 1;
  43   3              }
  44   2          }
  45   1          else if (KEY == 1 && keyPressed) {
  46   2              if (keyPressTime < LONG_PRESS_TIME) {
  47   3                  switch (sysState) {
  48   4                      case SYS_STATE_OFF:
  49   4                          // æ£€æŸ¥æ˜¯å¦å®šæ—¶æµ‡æ°´æ­£åœ¨è¿è¡Œ
  50   4                          if(!timed_watering.enabled) {
  51   5                              sysState = SYS_STATE_WATERING;
  52   5                              Relay_On();
  53   5                              FlowMeter_Reset();
  54   5                              FlowMeter_Start();
C51 COMPILER V9.54   MAIN                                                                  05/26/2025 21:55:47 PAGE 2   

  55   5                              FlowMeter_SetMode(FLOW_MODE_CURR);
  56   5                              FlowMeter_UpdateDisplay();
  57   5                              auto_display_mode = DISPLAY_MODE_CLOCK; // æ‰‹åŠ¨æµ‡æ°´æ—¶æ˜¾ç¤ºæ—¶é’Ÿ
  58   5                          }
  59   4                          break;
  60   4                          
  61   4                      case SYS_STATE_WATERING:
  62   4                          sysState = SYS_STATE_OFF;
  63   4                          Relay_Off();
  64   4                          FlowMeter_Stop();
  65   4                          FlowMeter_SetMode(FLOW_MODE_OFF);
  66   4                          break;
  67   4                          
  68   4                      case SYS_STATE_SET_HOUR:
  69   4                          PCA_IncreaseTimeValue(HOUR_POS);
  70   4                          break;
  71   4                          
  72   4                      case SYS_STATE_SET_MIN:
  73   4                          PCA_IncreaseTimeValue(MIN_POS);
  74   4                          break;
  75   4                          
  76   4                      case SYS_STATE_SET_SEC:
  77   4                          PCA_IncreaseTimeValue(SEC_POS);
  78   4                          break;
  79   4                  }
  80   3              } 
  81   2              else if (keyPressTime >= LONG_PRESS_TIME) {
  82   3                  if (justEnteredSetMode) {
  83   4                      justEnteredSetMode = 0;
  84   4                  }
  85   3                  else if (sysState >= SYS_STATE_SET_HOUR && sysState <= SYS_STATE_SET_SEC) {
  86   4                      sysState++;
  87   4                      
  88   4                      if (sysState > SYS_STATE_SET_SEC) {
  89   5                          sysState = SYS_STATE_OFF;
  90   5                          PCA_ExitTimeEditMode();
  91   5                      } else {
  92   5                          PCA_SetTimeEditMode(sysState - SYS_STATE_SET_HOUR + 1);
  93   5                      }
  94   4                  }
  95   3              }
  96   2              
  97   2              keyPressed = 0;
  98   2              keyPressTime = 0;
  99   2              delay_ms(20);
 100   2          }
 101   1      }
 102          
 103          void main(void) {
 104   1          EA = 1;
 105   1          P0 = 0xFF;
 106   1          
 107   1          /* 
 108   1           * ========================================
 109   1           * æ™ºèƒ½æµ‡èŠ±ç³»ç»Ÿ - å®šæ—¶å®šé‡æµ‡æ°´åŠŸèƒ½
 110   1           * ========================================
 111   1           * 
 112   1           * ã€ç³»ç»Ÿç‰¹ç‚¹ã€‘
 113   1           * ============
 114   1           * âœ“ ç²¾ç¡®æ—¶é—´æ§åˆ¶ï¼šå¯è®¾å®šæ¯å¤©å›ºå®šæ—¶é—´è‡ªåŠ¨æµ‡æ°´
 115   1           * âœ“ å®šé‡æµ‡æ°´ï¼šæŒ‰æ¯«å‡æ•°ç²¾ç¡®æ§åˆ¶æµ‡æ°´é‡
 116   1           * âœ“ æ•°æ®ä¿å­˜ï¼šç´¯è®¡æµé‡æ‰ç”µä¸ä¸¢å¤±
C51 COMPILER V9.54   MAIN                                                                  05/26/2025 21:55:47 PAGE 3   

 117   1           * âœ“ æ™ºèƒ½é˜²é‡ï¼šæ¯å¤©åªæ‰§è¡Œä¸€æ¬¡ï¼Œé¿å…é‡å¤æµ‡æ°´
 118   1           * âœ“ æ‰‹åŠ¨æ§åˆ¶ï¼šæ”¯æŒæ‰‹åŠ¨ç«‹å³æµ‡æ°´
 119   1           * âœ“ ä¸²å£è®¾ç½®ï¼šæ”¯æŒé€šè¿‡ä¸²å£è®¾ç½®ç³»ç»Ÿæ—¶é—´
 120   1           * 
 121   1           * ã€ç¡¬ä»¶è¿æ¥ã€‘
 122   1           * ============
 123   1           * æ§åˆ¶éƒ¨åˆ†ï¼š
 124   1           * - P1.1: ç»§ç”µå™¨æ§åˆ¶ (ä½ç”µå¹³è§¦å‘)
 125   1           * - P1.0: æ–¹æ³¢å‘ç”Ÿå™¨è¾“å‡º (5Hzè„‰å†²ä¿¡å·)
 126   1           * - P3.2: INT0ä¸­æ–­è¾“å…¥ (æµé‡è®¡è„‰å†²è®¡æ•°)
 127   1           * 
 128   1           * æŒ‰é”®è¾“å…¥ï¼š
 129   1           * - P1.2: å¯åŠ¨/åœæ­¢å®šæ—¶æµ‡æ°´
 130   1           * - P1.3: å¢åŠ å‚æ•°å€¼
 131   1           * - P1.4: å‡å°‘å‚æ•°å€¼  
 132   1           * - P1.7: åˆ‡æ¢è®¾ç½®æ¨¡å¼
 133   1           * - P3.3: æ‰‹åŠ¨æµ‡æ°´/æ—¶é—´è®¾ç½®
 134   1           * 
 135   1           * å­˜å‚¨è®¾å¤‡ï¼š
 136   1           * - P2.0: I2Cæ•°æ®çº¿SDA (è¿æ¥24C02)
 137   1           * - P2.1: I2Cæ—¶é’Ÿçº¿SCL (è¿æ¥24C02)
 138   1           * 
 139   1           * ã€å¿«é€Ÿä½¿ç”¨æŒ‡å—ã€‘
 140   1           * ================
 141   1           * 
 142   1           * ğŸ• ç¬¬ä¸€æ­¥ï¼šè®¾ç½®æµ‡æ°´æ—¶é—´
 143   1           *    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             -â”€â”€â”€â”€â”€â”€â”
 144   1           *    â”‚ 1. æŒ‰P1.7 â†’ æ•°ç ç®¡æ˜¾ç¤º"HH0002"      â”‚
 145   1           *    â”‚    ç”¨P1.3/P1.4è®¾ç½®å°æ—¶(0-23)       â”‚
 146   1           *    â”‚ 2. æŒ‰P1.7 â†’ æ•°ç ç®¡æ˜¾ç¤º"MM0003"      â”‚
 147   1           *    â”‚    ç”¨P1.3/P1.4è®¾ç½®åˆ†é’Ÿ(0-59)       â”‚
 148   1           *    â”‚ 3. æŒ‰P1.7 â†’ æ•°ç ç®¡æ˜¾ç¤º"SS0001"      â”‚
 149   1           *    â”‚    ç”¨P1.3/P1.4è®¾ç½®ç§’(0-59)         â”‚
 150   1           *    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             -â”€â”€â”€â”€â”€â”€â”˜
 151   1           * 
 152   1           * ğŸ’§ ç¬¬äºŒæ­¥ï¼šè®¾ç½®æµ‡æ°´é‡
 153   1           *    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             -â”€â”€â”€â”€â”€â”€â”
 154   1           *    â”‚ 4. æŒ‰P1.7 â†’ æ•°ç ç®¡æ˜¾ç¤º"MMMM05"      â”‚
 155   1           *    â”‚    ç”¨P1.3/P1.4è®¾ç½®æ¯«å‡æ•°            â”‚
 156   1           *    â”‚    (50-9999mlï¼Œæ­¥é•¿50ml)            â”‚
 157   1           *    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             -â”€â”€â”€â”€â”€â”€â”˜
 158   1           * 
 159   1           * â–¶ï¸ ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨å®šæ—¶æµ‡æ°´
 160   1           *    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             -â”€â”€â”€â”€â”€â”€â”
 161   1           *    â”‚ 5. æŒ‰P1.2å¯åŠ¨å®šæ—¶æµ‡æ°´åŠŸèƒ½           â”‚
 162   1           *    â”‚    ç³»ç»Ÿè¿›å…¥è‡ªåŠ¨æ¨¡å¼ï¼Œç­‰å¾…è®¾å®šæ—¶é—´    â”‚
 163   1           *    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             -â”€â”€â”€â”€â”€â”€â”˜
 164   1           * 
 165   1           * ã€æ•°ç ç®¡æ˜¾ç¤ºè¯´æ˜ã€‘
 166   1           * ==================
 167   1           * 
 168   1           * æ—¶é’Ÿæ¨¡å¼ï¼šæ˜¾ç¤ºå½“å‰æ—¶é—´ "HHMMSS"
 169   1           * ä¾‹å¦‚ï¼š145023 = 14:50:23
 170   1           * 
 171   1           * å‚æ•°è®¾ç½®æ¨¡å¼ï¼š
 172   1           * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€
C51 COMPILER V9.54   MAIN                                                                  05/26/2025 21:55:47 PAGE 4   

             -â”€â”€â”€â”€â”€â”€â”€â”€â”
 173   1           * â”‚ æ˜¾ç¤ºæ ¼å¼  â”‚    å«ä¹‰     â”‚    ç¤ºä¾‹      â”‚
 174   1           * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€
             -â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 175   1           * â”‚ HH0003   â”‚  è®¾ç½®å°æ—¶   â”‚ 060003=6ç‚¹   â”‚
 176   1           * â”‚ MM0002   â”‚  è®¾ç½®åˆ†é’Ÿ   â”‚ 300002=30åˆ†  â”‚
 177   1           * â”‚ SS0001   â”‚  è®¾ç½®ç§’     â”‚ 450001=45ç§’  â”‚
 178   1           * â”‚ MMMM05   â”‚  è®¾ç½®æ¯«å‡   â”‚ 150005=150ml â”‚
 179   1           * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€
             -â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 180   1           * 
 181   1           * æµ‡æ°´çŠ¶æ€ï¼š
 182   1           * - ç­‰å¾…æµ‡æ°´ï¼šå‚æ•°é—ªçƒæ˜¾ç¤º
 183   1           * - æ­£åœ¨æµ‡æ°´ï¼šæ˜¾ç¤ºå‰©ä½™æ¯«å‡æ•° "XXXX05"
 184   1           * - æµ‡æ°´å®Œæˆï¼šè¿”å›æ—¶é’Ÿæ˜¾ç¤º
 185   1           * 
 186   1           * ã€å®é™…ä½¿ç”¨ä¾‹å­ã€‘
 187   1           * ================
 188   1           * 
 189   1           * ğŸŒ± åœºæ™¯1ï¼šæ¯å¤©æ—©ä¸Š7ç‚¹æµ‡150æ¯«å‡æ°´
 190   1           * æ­¥éª¤ï¼š
 191   1           * 1. P1.7 â†’ è®¾ç½®"070003" (7ç‚¹)
 192   1           * 2. P1.7 â†’ è®¾ç½®"000002" (0åˆ†) 
 193   1           * 3. P1.7 â†’ è®¾ç½®"000001" (0ç§’)
 194   1           * 4. P1.7 â†’ è®¾ç½®"150005" (150æ¯«å‡)
 195   1           * 5. P1.2 â†’ å¯åŠ¨å®šæ—¶æµ‡æ°´
 196   1           * ç»“æœï¼šæ¯å¤©7:00:00è‡ªåŠ¨æµ‡æ°´150æ¯«å‡
 197   1           * 
 198   1           * ğŸŒ± åœºæ™¯2ï¼šå‚æ™š6ç‚¹åŠæµ‡100æ¯«å‡æ°´  
 199   1           * æ­¥éª¤ï¼š
 200   1           * 1. P1.7 â†’ è®¾ç½®"180003" (18ç‚¹)
 201   1           * 2. P1.7 â†’ è®¾ç½®"300002" (30åˆ†)
 202   1           * 3. P1.7 â†’ è®¾ç½®"000001" (0ç§’) 
 203   1           * 4. P1.7 â†’ è®¾ç½®"100005" (100æ¯«å‡)
 204   1           * 5. P1.2 â†’ å¯åŠ¨å®šæ—¶æµ‡æ°´
 205   1           * ç»“æœï¼šæ¯å¤©18:30:00è‡ªåŠ¨æµ‡æ°´100æ¯«å‡
 206   1           * 
 207   1           * ã€æ•…éšœå¤„ç†ã€‘
 208   1           * ============
 209   1           * 
 210   1           * Q: è®¾ç½®æ—¶é—´åä¸æµ‡æ°´ï¼Ÿ
 211   1           * A: æ£€æŸ¥æ˜¯å¦æŒ‰P1.2å¯åŠ¨å®šæ—¶åŠŸèƒ½
 212   1           * 
 213   1           * Q: æµ‡æ°´é‡ä¸å‡†ç¡®ï¼Ÿ
 214   1           * A: æ£€æŸ¥æµé‡è®¡è¿æ¥å’Œæ–¹æ³¢å‘ç”Ÿå™¨é¢‘ç‡
 215   1           * 
 216   1           * Q: æ–­ç”µåç´¯è®¡æµé‡ä¸¢å¤±ï¼Ÿ
 217   1           * A: æ£€æŸ¥24C02è¿æ¥å’ŒI2Cé€šä¿¡
 218   1           * 
 219   1           * Q: æ¯å¤©æµ‡æ°´å¤šæ¬¡ï¼Ÿ
 220   1           * A: ç³»ç»Ÿè®¾è®¡ä¸ºæ¯å¤©åªæµ‡ä¸€æ¬¡ï¼Œå¦‚å‡ºç°è¯·æ£€æŸ¥æ—¶é’Ÿ
 221   1           */
 222   1          
 223   1          PCA_Init();
 224   1          Relay_Init();
 225   1          WaveGen_Init();
 226   1          WaveGen_Start();
 227   1          FlowMeter_Init();
 228   1          UART_Init();
 229   1          KeyboardControl_Init();  // åˆå§‹åŒ–æŒ‰é”®æ§åˆ¶
 230   1          
 231   1          // å‘é€å¯åŠ¨ä¿¡æ¯åˆ°ä¸²å£
C51 COMPILER V9.54   MAIN                                                                  05/26/2025 21:55:47 PAGE 5   

 232   1          UART_SendString("\r\næµ‡èŠ±ç³»ç»Ÿå·²å¯åŠ¨\r\n");
 233   1          UART_SendString("å½“å‰æ—¶é—´è®¾ç½®åŠŸèƒ½å¯ç”¨\r\n");
 234   1          UART_SendString("å®šæ—¶æµ‡æ°´åŠŸèƒ½å·²åˆå§‹åŒ–\r\n");
 235   1          
 236   1          while (1) {
 237   2              processKey();
 238   2              KeyboardControl_Scan();
 239   2              CheckAndUpdateAutoDisplay();
 240   2              FlowMeter_UpdateDisplay();
 241   2              UART_ProcessCommand();
 242   2              
 243   2              // æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰- æ³¨é‡Šæ‰ä»¥é¿å…é¢‘ç¹è¾“å‡º
 244   2              /*
 245   2              static BYTE debug_counter = 0;
 246   2              if(++debug_counter >= 100) {  // æ¯1ç§’è¾“å‡ºä¸€æ¬¡çŠ¶æ€
 247   2                  debug_counter = 0;
 248   2                  if(timed_watering.enabled) {
 249   2                      UART_SendString("å®šæ—¶æµ‡æ°´å·²å¯ç”¨ï¼Œç­‰å¾…æ—¶é—´: ");
 250   2                      // å‘é€å½“å‰æ—¶é—´å’Œè®¾å®šæ—¶é—´
 251   2                  }
 252   2              }
 253   2              */
 254   2              
 255   2              delay_ms(10);
 256   2          }
 257   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    308    ----
   CONSTANT SIZE    =     92    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      3    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
