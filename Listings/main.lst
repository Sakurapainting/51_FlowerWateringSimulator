C51 COMPILER V9.54   MAIN                                                                  05/27/2025 13:05:35 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\Keil5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main.l
                    -st) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <reg51.h>
   2          #include <INTRINS.H>
   3          #include "pca.h"
   4          #include "relay.h"     // 包含继电器控制头文件
   5          #include "wavegen.h"   // 包含方波发生器头文件
   6          #include "flowmeter.h" // 包含流量计头文件
   7          #include "uart.h"      // 添加串口通信头文件
   8          #include "keyboard_control.h"  // 添加按键控制头文件
   9          #include "i2c.h"      // 添加I2C头文件
  10          
  11          #define multiplier 1.085
  12          
  13          // 系统状态定义
  14          #define SYS_STATE_OFF      0  // 系统关闭
  15          #define SYS_STATE_WATERING 1  // 系统浇水中
  16          #define SYS_STATE_SET_HOUR 2  // 设置小时
  17          #define SYS_STATE_SET_MIN  3  // 设置分钟
  18          #define SYS_STATE_SET_SEC  4  // 设置秒
  19          
  20          // 当前系统状态
  21          BYTE sysState = SYS_STATE_OFF;
  22          
  23          // 按键和浇水控制相关变量
  24          sbit KEY = P3^3;            // 按键连接到P3.3
  25          bit keyPressed = 0;         // 按键按下标志
  26          bit justEnteredSetMode = 0; // 标志是否刚刚进入设置模式
  27          unsigned int keyPressTime = 0; // 按键按下持续时间（以10ms为单位）
  28          #define LONG_PRESS_TIME 500   // 长按时间阈值（约1秒）
  29          
  30          // 按键处理函数
  31          void processKey() {
  32   1          if (KEY == 0 && !keyPressed) {
  33   2              keyPressed = 1;
  34   2              keyPressTime = 0;
  35   2          } 
  36   1          else if (KEY == 0 && keyPressed) {
  37   2              keyPressTime++;
  38   2              
  39   2              if (keyPressTime == LONG_PRESS_TIME && sysState == SYS_STATE_OFF) {
  40   3                  sysState = SYS_STATE_SET_HOUR;
  41   3                  PCA_SetTimeEditMode(sysState - SYS_STATE_SET_HOUR + 1);
  42   3                  justEnteredSetMode = 1;
  43   3              }
  44   2          }
  45   1          else if (KEY == 1 && keyPressed) {
  46   2              if (keyPressTime < LONG_PRESS_TIME) {
  47   3                  switch (sysState) {
  48   4                      case SYS_STATE_OFF:
  49   4                          // 检查是否定时浇水正在运行
  50   4                          if(!timed_watering.enabled) {
  51   5                              sysState = SYS_STATE_WATERING;
  52   5                              Relay_On();
  53   5                              FlowMeter_Reset();
  54   5                              FlowMeter_Start();
C51 COMPILER V9.54   MAIN                                                                  05/27/2025 13:05:35 PAGE 2   

  55   5                              FlowMeter_SetMode(FLOW_MODE_CURR);
  56   5                              FlowMeter_UpdateDisplay();
  57   5                              auto_display_mode = DISPLAY_MODE_CLOCK; // 手动浇水时显示时钟
  58   5                          }
  59   4                          break;
  60   4                          
  61   4                      case SYS_STATE_WATERING:
  62   4                          sysState = SYS_STATE_OFF;
  63   4                          Relay_Off();
  64   4                          FlowMeter_Stop();
  65   4                          FlowMeter_SetMode(FLOW_MODE_OFF);
  66   4                          break;
  67   4                          
  68   4                      case SYS_STATE_SET_HOUR:
  69   4                          PCA_IncreaseTimeValue(HOUR_POS);
  70   4                          break;
  71   4                          
  72   4                      case SYS_STATE_SET_MIN:
  73   4                          PCA_IncreaseTimeValue(MIN_POS);
  74   4                          break;
  75   4                          
  76   4                      case SYS_STATE_SET_SEC:
  77   4                          PCA_IncreaseTimeValue(SEC_POS);
  78   4                          break;
  79   4                  }
  80   3              } 
  81   2              else if (keyPressTime >= LONG_PRESS_TIME) {
  82   3                  if (justEnteredSetMode) {
  83   4                      justEnteredSetMode = 0;
  84   4                  }
  85   3                  else if (sysState >= SYS_STATE_SET_HOUR && sysState <= SYS_STATE_SET_SEC) {
  86   4                      sysState++;
  87   4                      
  88   4                      if (sysState > SYS_STATE_SET_SEC) {
  89   5                          sysState = SYS_STATE_OFF;
  90   5                          PCA_ExitTimeEditMode();
  91   5                      } else {
  92   5                          PCA_SetTimeEditMode(sysState - SYS_STATE_SET_HOUR + 1);
  93   5                      }
  94   4                  }
  95   3              }
  96   2              
  97   2              keyPressed = 0;
  98   2              keyPressTime = 0;
  99   2              delay_ms(20);
 100   2          }
 101   1      }
 102          
 103          void main(void) {
 104   1          EA = 1;
 105   1          P0 = 0xFF;
 106   1          
 107   1          /* 
 108   1           * ========================================
 109   1           * 智能浇花系统 - 定时定量浇水功能
 110   1           * ========================================
 111   1           * 
 112   1           * 【系统特点】
 113   1           * ============
 114   1           * ✓ 精确时间控制：可设定每天固定时间自动浇水
 115   1           * ✓ 定量浇水：按毫升数精确控制浇水量
 116   1           * ✓ 数据保存：累计流量掉电不丢失
C51 COMPILER V9.54   MAIN                                                                  05/27/2025 13:05:35 PAGE 3   

 117   1           * ✓ 智能防重：每天只执行一次，避免重复浇水
 118   1           * ✓ 手动控制：支持手动立即浇水
 119   1           * ✓ 串口设置：支持通过串口设置系统时间
 120   1           * 
 121   1           * 【硬件连接】
 122   1           * ============
 123   1           * 控制部分：
 124   1           * - P1.1: 继电器控制 (低电平触发)
 125   1           * - P1.0: 方波发生器输出 (5Hz脉冲信号)
 126   1           * - P3.2: INT0中断输入 (流量计脉冲计数)
 127   1           * 
 128   1           * 按键输入：
 129   1           * - P1.2: 启动/停止定时浇水
 130   1           * - P1.3: 增加参数值
 131   1           * - P1.4: 减少参数值  
 132   1           * - P1.7: 切换设置模式
 133   1           * - P3.3: 手动浇水/时间设置
 134   1           * 
 135   1           * 存储设备：
 136   1           * - P2.0: I2C数据线SDA (连接24C02)
 137   1           * - P2.1: I2C时钟线SCL (连接24C02)
 138   1           * 
 139   1           * 【快速使用指南】
 140   1           * ================
 141   1           * 
 142   1           * 🕐 第一步：设置浇水时间
 143   1           *    ┌───────────────────────────────
             -──────┐
 144   1           *    │ 1. 按P1.7 → 数码管显示"HH0002"      │
 145   1           *    │    用P1.3/P1.4设置小时(0-23)       │
 146   1           *    │ 2. 按P1.7 → 数码管显示"MM0003"      │
 147   1           *    │    用P1.3/P1.4设置分钟(0-59)       │
 148   1           *    │ 3. 按P1.7 → 数码管显示"SS0001"      │
 149   1           *    │    用P1.3/P1.4设置秒(0-59)         │
 150   1           *    └───────────────────────────────
             -──────┘
 151   1           * 
 152   1           * 💧 第二步：设置浇水量
 153   1           *    ┌───────────────────────────────
             -──────┐
 154   1           *    │ 4. 按P1.7 → 数码管显示"MMMM05"      │
 155   1           *    │    用P1.3/P1.4设置毫升数            │
 156   1           *    │    (50-9999ml，步长50ml)            │
 157   1           *    └───────────────────────────────
             -──────┘
 158   1           * 
 159   1           * ▶️ 第三步：启动定时浇水
 160   1           *    ┌───────────────────────────────
             -──────┐
 161   1           *    │ 5. 按P1.2启动定时浇水功能           │
 162   1           *    │    系统进入自动模式，等待设定时间    │
 163   1           *    └───────────────────────────────
             -──────┘
 164   1           * 
 165   1           * 【数码管显示说明】
 166   1           * ==================
 167   1           * 
 168   1           * 时钟模式：显示当前时间 "HHMMSS"
 169   1           * 例如：145023 = 14:50:23
 170   1           * 
 171   1           * 参数设置模式：
 172   1           * ┌──────────┬─────────────┬───────
C51 COMPILER V9.54   MAIN                                                                  05/27/2025 13:05:35 PAGE 4   

             -────────┐
 173   1           * │ 显示格式  │    含义     │    示例      │
 174   1           * ├──────────┼─────────────┼───────
             -────────┤
 175   1           * │ HH0003   │  设置小时   │ 060003=6点   │
 176   1           * │ MM0002   │  设置分钟   │ 300002=30分  │
 177   1           * │ SS0001   │  设置秒     │ 450001=45秒  │
 178   1           * │ MMMM05   │  设置毫升   │ 150005=150ml │
 179   1           * └──────────┴─────────────┴───────
             -────────┘
 180   1           * 
 181   1           * 浇水状态：
 182   1           * - 等待浇水：参数闪烁显示
 183   1           * - 正在浇水：显示剩余毫升数 "XXXX05"
 184   1           * - 浇水完成：返回时钟显示
 185   1           * 
 186   1           * 【实际使用例子】
 187   1           * ================
 188   1           * 
 189   1           * 🌱 场景1：每天早上7点浇150毫升水
 190   1           * 步骤：
 191   1           * 1. P1.7 → 设置"070003" (7点)
 192   1           * 2. P1.7 → 设置"000002" (0分) 
 193   1           * 3. P1.7 → 设置"000001" (0秒)
 194   1           * 4. P1.7 → 设置"150005" (150毫升)
 195   1           * 5. P1.2 → 启动定时浇水
 196   1           * 结果：每天7:00:00自动浇水150毫升
 197   1           * 
 198   1           * 🌱 场景2：傍晚6点半浇100毫升水  
 199   1           * 步骤：
 200   1           * 1. P1.7 → 设置"180003" (18点)
 201   1           * 2. P1.7 → 设置"300002" (30分)
 202   1           * 3. P1.7 → 设置"000001" (0秒) 
 203   1           * 4. P1.7 → 设置"100005" (100毫升)
 204   1           * 5. P1.2 → 启动定时浇水
 205   1           * 结果：每天18:30:00自动浇水100毫升
 206   1           * 
 207   1           * 【故障处理】
 208   1           * ============
 209   1           * 
 210   1           * Q: 设置时间后不浇水？
 211   1           * A: 检查是否按P1.2启动定时功能
 212   1           * 
 213   1           * Q: 浇水量不准确？
 214   1           * A: 检查流量计连接和方波发生器频率
 215   1           * 
 216   1           * Q: 断电后累计流量丢失？
 217   1           * A: 检查24C02连接和I2C通信
 218   1           * 
 219   1           * Q: 每天浇水多次？
 220   1           * A: 系统设计为每天只浇一次，如出现请检查时钟
 221   1           */
 222   1          
 223   1          PCA_Init();
 224   1          Relay_Init();
 225   1          WaveGen_Init();
 226   1          WaveGen_Start();
 227   1          FlowMeter_Init();
 228   1          UART_Init();
 229   1          KeyboardControl_Init();  // 初始化按键控制
 230   1          
 231   1          // 发送英文启动信息到串口
C51 COMPILER V9.54   MAIN                                                                  05/27/2025 13:05:35 PAGE 5   

 232   1          UART_SendString("\r\nWatering System Started\r\n");
 233   1          UART_SendString("Time setting available\r\n");
 234   1          UART_SendString("Auto watering initialized\r\n");
 235   1          
 236   1          while (1) {
 237   2              processKey();
 238   2              KeyboardControl_Scan();
 239   2              CheckAndUpdateAutoDisplay();
 240   2              FlowMeter_UpdateDisplay();
 241   2              UART_ProcessCommand();
 242   2              
 243   2              delay_ms(10);
 244   2          }
 245   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    308    ----
   CONSTANT SIZE    =     81    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      3    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
