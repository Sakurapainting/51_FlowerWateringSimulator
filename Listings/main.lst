C51 COMPILER V9.54   MAIN                                                                  05/25/2025 14:34:33 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\Keil5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main.l
                    -st) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <reg51.h>
   2          #include <INTRINS.H>
   3          #include "pca.h"
   4          #include "relay.h"     // 包含继电器控制头文件
   5          #include "wavegen.h"   // 包含方波发生器头文件
   6          #include "flowmeter.h" // 包含流量计头文件
   7          
   8          #define multiplier 1.085
   9          
  10          // 系统状态定义
  11          #define SYS_STATE_OFF     0  // 系统关闭
  12          #define SYS_STATE_WATERING 1  // 系统浇水中
  13          
  14          // 当前系统状态
  15          BYTE sysState = SYS_STATE_OFF;
  16          
  17          // 按键和浇水控制相关变量
  18          sbit KEY = P3^3;            // 按键连接到P3.3
  19          bit keyPressed = 0;         // 按键按下标志
  20          
  21          // 按键处理函数
  22          void processKey() {
  23   1          if (KEY == 0 && !keyPressed) {  // 按键按下（低电平有效）
  24   2              keyPressed = 1;
  25   2              
  26   2              // 切换系统状态
  27   2              if (sysState == SYS_STATE_OFF) {
  28   3                  // 开启浇水系统
  29   3                  sysState = SYS_STATE_WATERING;
  30   3                  Relay_On();                    // 打开继电器
  31   3                  
  32   3                  // 重置和启动流量计
  33   3                  FlowMeter_Reset();             // 重置流量计计数
  34   3                  FlowMeter_Start();             // 启动流量计
  35   3                  FlowMeter_SetMode(FLOW_MODE_CURR); // 设置为显示当前流量
  36   3                  
  37   3                  // 强制立即更新显示
  38   3                  FlowMeter_UpdateDisplay();
  39   3              } else {
  40   3                  // 关闭浇水系统
  41   3                  sysState = SYS_STATE_OFF;
  42   3                  Relay_Off();                  // 关闭继电器
  43   3                  FlowMeter_Stop();             // 停止流量计
  44   3                  FlowMeter_SetMode(FLOW_MODE_OFF); // 设置为显示时间
  45   3              }
  46   2              
  47   2              delay_ms(20);  // 简单消抖
  48   2          } 
  49   1          else if (KEY == 1 && keyPressed) {  // 按键释放
  50   2              keyPressed = 0;
  51   2              delay_ms(20);  // 简单消抖
  52   2          }
  53   1      }
  54          
C51 COMPILER V9.54   MAIN                                                                  05/25/2025 14:34:33 PAGE 2   

  55          void main(void) {
  56   1          EA = 1;               // 开启总中断
  57   1          P0 = 0xFF;
  58   1          
  59   1          /* 浇花系统引脚连接与工作说明：
  60   1           * 1. P1.1 - 输出：控制继电器，高电平开启浇水，低电平关闭浇水
  61   1           * 2. P1.0 - 输出：方波发生器，输出5Hz脉冲，模拟流量计信号
  62   1           * 3. P3.2 (INT0) - 输入：外部中断，接收流量计脉冲进行计数
  63   1           * 4. P3.3 - 输入：按键输入，控制浇水系统的开关
  64   1           * 5. P2.0-P2.3 - 输出：连接到74HC595，控制数码管显示
  65   1           * 
  66   1           * 浇水工作过程：
  67   1           * - 按下P3.3按键后，系统开始浇水：P1.1输出高电平，继电器闭合
  68   1           * - 继电器闭合使P1.0的方波信号传导到P3.2 (INT0)
  69   1           * - INT0接收脉冲信号并计数，根据脉冲数计算流量
  70   1           * - 显示屏轮流显示当前流量和累计流量
  71   1           * - 再次按下按键，系统停止浇水：P1.1输出低电平，继电器断开
  72   1           * - 断开后不再有脉冲传到INT0，流量计数停止
  73   1           * - 显示屏切换回时间显示模式
  74   1           */
  75   1          
  76   1          PCA_Init();           // 初始化PCA模块，包含时钟功能
  77   1          Relay_Init();         // 初始化继电器
  78   1          WaveGen_Init();       // 初始化方波发生器
  79   1          WaveGen_Start();      // 启动方波发生器产生5Hz方波
  80   1          FlowMeter_Init();     // 初始化流量计
  81   1          
  82   1          while (1) {
  83   2              processKey();               // 处理按键输入
  84   2              FlowMeter_UpdateDisplay();  // 检查并更新流量显示
  85   2              
  86   2              // 添加一个简短延时以避免CPU高速空转
  87   2              delay_ms(10);
  88   2          }
  89   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    101    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
