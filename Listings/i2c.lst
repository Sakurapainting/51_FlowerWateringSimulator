C51 COMPILER V9.54   I2C                                                                   05/27/2025 12:57:11 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE I2C
OBJECT MODULE PLACED IN .\Objects\i2c.obj
COMPILER INVOKED BY: D:\Keil5\C51\BIN\C51.EXE i2c.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\i2c.lst
                    -) OBJECT(.\Objects\i2c.obj)

line level    source

   1          #include "i2c.h"
   2          #include "intrins.h"
   3          
   4          // I2C延时函数
   5          static void I2C_Delay(void) {
   6   1          _nop_();
   7   1          _nop_();
   8   1          _nop_();
   9   1          _nop_();
  10   1      }
  11          
  12          // I2C初始化
  13          void I2C_Init(void) {
  14   1          SDA = 1;
  15   1          SCL = 1;
  16   1      }
  17          
  18          // 发送起始信号
  19          void I2C_Start(void) {
  20   1          SDA = 1;
  21   1          SCL = 1;
  22   1          I2C_Delay();
  23   1          SDA = 0;
  24   1          I2C_Delay();
  25   1          SCL = 0;
  26   1      }
  27          
  28          // 发送停止信号
  29          void I2C_Stop(void) {
  30   1          SDA = 0;
  31   1          SCL = 0;
  32   1          I2C_Delay();
  33   1          SCL = 1;
  34   1          I2C_Delay();
  35   1          SDA = 1;
  36   1          I2C_Delay();
  37   1      }
  38          
  39          // 发送一个字节，返回ACK状态
  40          bit I2C_SendByte(BYTE dat) {
  41   1          BYTE i;
  42   1          
  43   1          for(i = 0; i < 8; i++) {
  44   2              SCL = 0;
  45   2              I2C_Delay();
  46   2              SDA = (dat & 0x80) ? 1 : 0;
  47   2              dat <<= 1;
  48   2              I2C_Delay();
  49   2              SCL = 1;
  50   2              I2C_Delay();
  51   2          }
  52   1          
  53   1          SCL = 0;
  54   1          I2C_Delay();
C51 COMPILER V9.54   I2C                                                                   05/27/2025 12:57:11 PAGE 2   

  55   1          SDA = 1;
  56   1          I2C_Delay();
  57   1          SCL = 1;
  58   1          I2C_Delay();
  59   1          
  60   1          return SDA;  // 返回ACK状态，0表示ACK，1表示NACK
  61   1      }
  62          
  63          // 接收一个字节
  64          BYTE I2C_ReceiveByte(bit ack) {
  65   1          BYTE i, dat = 0;
  66   1          
  67   1          SDA = 1;
  68   1          for(i = 0; i < 8; i++) {
  69   2              SCL = 0;
  70   2              I2C_Delay();
  71   2              SCL = 1;
  72   2              I2C_Delay();
  73   2              dat <<= 1;
  74   2              if(SDA) dat |= 0x01;
  75   2          }
  76   1          
  77   1          SCL = 0;
  78   1          I2C_Delay();
  79   1          SDA = ack ? 0 : 1;  // 发送ACK或NACK
  80   1          I2C_Delay();
  81   1          SCL = 1;
  82   1          I2C_Delay();
  83   1          SCL = 0;
  84   1          I2C_Delay();
  85   1          
  86   1          return dat;
  87   1      }
  88          
  89          // 写一个字节到24C02
  90          void AT24C02_WriteByte(BYTE addr, BYTE dat) {
  91   1          I2C_Start();
  92   1          I2C_SendByte(AT24C02_ADDR);      // 发送器件地址+写命令
  93   1          I2C_SendByte(addr);              // 发送存储地址
  94   1          I2C_SendByte(dat);               // 发送数据
  95   1          I2C_Stop();
  96   1          
  97   1          // 等待写入完成
  98   1          delay_ms(10);
  99   1      }
 100          
 101          // 从24C02读一个字节
 102          BYTE AT24C02_ReadByte(BYTE addr) {
 103   1          BYTE dat;
 104   1          
 105   1          I2C_Start();
 106   1          I2C_SendByte(AT24C02_ADDR);      // 发送器件地址+写命令
 107   1          I2C_SendByte(addr);              // 发送存储地址
 108   1          
 109   1          I2C_Start();                     // 重新开始
 110   1          I2C_SendByte(AT24C02_ADDR | 0x01); // 发送器件地址+读命令
 111   1          dat = I2C_ReceiveByte(0);        // 读取数据，发送NACK
 112   1          I2C_Stop();
 113   1          
 114   1          return dat;
 115   1      }
 116          
C51 COMPILER V9.54   I2C                                                                   05/27/2025 12:57:11 PAGE 3   

 117          // 写累计流量到24C02（4字节）
 118          void AT24C02_WriteTotalFlow(unsigned long flow) {
 119   1          AT24C02_WriteByte(TOTAL_FLOW_ADDR_0, (BYTE)(flow & 0xFF));
 120   1          AT24C02_WriteByte(TOTAL_FLOW_ADDR_1, (BYTE)((flow >> 8) & 0xFF));
 121   1          AT24C02_WriteByte(TOTAL_FLOW_ADDR_2, (BYTE)((flow >> 16) & 0xFF));
 122   1          AT24C02_WriteByte(TOTAL_FLOW_ADDR_3, (BYTE)((flow >> 24) & 0xFF));
 123   1      }
 124          
 125          // 从24C02读累计流量（4字节）
 126          unsigned long AT24C02_ReadTotalFlow(void) {
 127   1          unsigned long flow = 0;
 128   1          
 129   1          flow  = (unsigned long)AT24C02_ReadByte(TOTAL_FLOW_ADDR_0);
 130   1          flow |= (unsigned long)AT24C02_ReadByte(TOTAL_FLOW_ADDR_1) << 8;
 131   1          flow |= (unsigned long)AT24C02_ReadByte(TOTAL_FLOW_ADDR_2) << 16;
 132   1          flow |= (unsigned long)AT24C02_ReadByte(TOTAL_FLOW_ADDR_3) << 24;
 133   1          
 134   1          return flow;
 135   1      }
 136          
 137          // 移除定时浇水参数相关函数
 138          // void AT24C02_WriteTimedWateringParams(TimedWatering *params) {
 139          //     // 移除此函数
 140          // }
 141          
 142          // void AT24C02_ReadTimedWateringParams(TimedWatering *params) {
 143          //     // 移除此函数
 144          // }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    397    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       8
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
