C51 COMPILER V9.54   I2C                                                                   05/28/2025 16:26:36 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE I2C
OBJECT MODULE PLACED IN .\Objects\i2c.obj
COMPILER INVOKED BY: D:\Keil5\C51\BIN\C51.EXE i2c.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\i2c.lst
                    -) OBJECT(.\Objects\i2c.obj)

line level    source

   1          #include "i2c.h"
   2          #include "intrins.h"
   3          
   4          // 全局变量定义
   5          unsigned long xdata totalFlow = 0;  // 从flowmeter.c移至此处
   6          
   7          // 外部变量声明（如果需要访问闹钟时间）
   8          // extern AlarmTime alarmTime;  // 如果项目中有闹钟功能，取消注释
   9          
  10          /**
  11           * @brief I2C起始信号
  12           */
  13          void I2C_Start() {
  14   1          SDA = 1; _nop_();
  15   1          SCL = 1; _nop_();
  16   1          SDA = 0; _nop_();
  17   1          SCL = 0; _nop_();
  18   1      }
  19          
  20          /**
  21           * @brief I2C停止信号
  22           */
  23          void I2C_Stop() {
  24   1          SDA = 0; _nop_();
  25   1          SCL = 1; _nop_();
  26   1          SDA = 1; _nop_();
  27   1      }
  28          
  29          /**
  30           * @brief 发送应答信号
  31           * @param ack 0:应答 1:非应答
  32           */
  33          void I2C_SendAck(bit ack) {
  34   1          SDA = ack; _nop_();
  35   1          SCL = 1; _nop_();
  36   1          SCL = 0; _nop_();
  37   1          SDA = 1; _nop_();
  38   1      }
  39          
  40          /**
  41           * @brief 等待应答信号
  42           * @return 0:应答成功 1:应答失败
  43           */
  44          bit I2C_WaitAck() {
  45   1          SDA = 1; _nop_();
  46   1          SCL = 1; _nop_();
  47   1          if(SDA) { // 应答失败
  48   2              SCL = 0; _nop_();
  49   2              return 1;
  50   2          }
  51   1          SCL = 0; _nop_();
  52   1          return 0;
  53   1      }
  54          
C51 COMPILER V9.54   I2C                                                                   05/28/2025 16:26:36 PAGE 2   

  55          /**
  56           * @brief 写一个字节
  57           * @param dat 要写入的字节
  58           */
  59          void I2C_WriteByte(unsigned char dat) {
  60   1          unsigned char i;
  61   1          for(i=0; i<8; i++) {
  62   2              SDA = (dat & 0x80) ? 1 : 0;
  63   2              SCL = 1; _nop_();
  64   2              SCL = 0; _nop_();
  65   2              dat <<= 1;
  66   2          }
  67   1          I2C_WaitAck();
  68   1      }
  69          
  70          /**
  71           * @brief 读一个字节
  72           * @param ack 是否发送应答信号 0:应答 1:非应答
  73           * @return 读取的字节
  74           */
  75          unsigned char I2C_ReadByte(bit ack) {
  76   1          unsigned char i, dat = 0;
  77   1          SDA = 1;
  78   1          for(i=0; i<8; i++) {
  79   2              SCL = 1; _nop_();
  80   2              dat <<= 1;
  81   2              dat |= SDA;
  82   2              SCL = 0; _nop_();
  83   2          }
  84   1          I2C_SendAck(ack);
  85   1          return dat;
  86   1      }
  87          
  88          
  89          /**
  90           * @brief 向EEPROM写入unsigned long数据(4字节)
  91           * @param addr 起始地址
  92           * @param dat 要写入的数据
  93           */
  94          void EEPROM_WriteULong(unsigned char addr, unsigned long dat) {
  95   1          I2C_Start();
  96   1          I2C_WriteByte(EEPROM_ADDR);    // 器件地址+写
  97   1          I2C_WriteByte(addr);           // 存储地址
  98   1          
  99   1          // 分4次写入，从低字节到高字节
 100   1          I2C_WriteByte((unsigned char)(dat & 0xFF));
 101   1          I2C_WriteByte((unsigned char)((dat >> 8) & 0xFF));
 102   1          I2C_WriteByte((unsigned char)((dat >> 16) & 0xFF));
 103   1          I2C_WriteByte((unsigned char)((dat >> 24) & 0xFF));
 104   1          
 105   1          I2C_Stop();
 106   1          delay_ms(20);                  // 写入时间稍长
 107   1      }
 108          
 109          /**
 110           * @brief 从EEPROM读取unsigned long数据(4字节)
 111           * @param addr 起始地址
 112           * @return 读取的数据
 113           */
 114          unsigned long EEPROM_ReadULong(unsigned char addr) {
 115   1          unsigned long dat = 0;
 116   1          I2C_Start();
C51 COMPILER V9.54   I2C                                                                   05/28/2025 16:26:36 PAGE 3   

 117   1          I2C_WriteByte(EEPROM_ADDR);    // 器件地址+写
 118   1          I2C_WriteByte(addr);           // 存储地址
 119   1      
 120   1          I2C_Start();
 121   1          I2C_WriteByte(EEPROM_ADDR|1);  // 器件地址+读
 122   1          
 123   1          // 分4次读取，从低字节到高字节
 124   1          dat = I2C_ReadByte(0);         // 读取低字节(发送应答)
 125   1          dat |= (unsigned long)I2C_ReadByte(0) << 8;
 126   1          dat |= (unsigned long)I2C_ReadByte(0) << 16;
 127   1          dat |= (unsigned long)I2C_ReadByte(1) << 24; // 最后一个字节发送非应答
 128   1          
 129   1          I2C_Stop();
 130   1          return dat;
 131   1      }
 132          
 133          // ===== 兼容原有接口的函数实现 =====
 134          
 135          // I2C初始化
 136          void I2C_Init(void) {
 137   1          SDA = 1;
 138   1          SCL = 1;
 139   1      }
 140          
 141          // 写累计流量到24C02（兼容接口）
 142          void AT24C02_WriteTotalFlow(unsigned long flow) {
 143   1          EEPROM_WriteULong(TOTAL_FLOW_ADDR_0, flow);
 144   1      }
 145          
 146          // 从24C02读累计流量（兼容接口）
 147          unsigned long AT24C02_ReadTotalFlow(void) {
 148   1          return EEPROM_ReadULong(TOTAL_FLOW_ADDR_0);
 149   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    379    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      4    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      13
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
