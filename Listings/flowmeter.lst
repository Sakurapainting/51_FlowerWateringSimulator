C51 COMPILER V9.54   FLOWMETER                                                             05/28/2025 12:20:34 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE FLOWMETER
OBJECT MODULE PLACED IN .\Objects\flowmeter.obj
COMPILER INVOKED BY: D:\Keil5\C51\BIN\C51.EXE flowmeter.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\f
                    -lowmeter.lst) OBJECT(.\Objects\flowmeter.obj)

line level    source

   1          #include "flowmeter.h"
   2          #include "intrins.h"
   3          #include "i2c.h"  
   4          #include "uart.h"
   5          
   6          /*
   7           * ========================================
   8           * 流量计系统 - 硬件连接说明
   9           * ========================================
  10           * 
  11           * 【引脚连接图】
  12           * ==============
  13           * 
  14           * 51单片机                   外设连接
  15           * ┌─────────────────────────────────
             -───────────────┐
  16           * │                                                 │
  17           * │  P1.0 ───────────┐                            │
  18           * │                  │                            │
  19           * │                  ├──> 继电器常开触点1          │
  20           * │                  │                            │
  21           * │  P1.1 ───────────┼──> 继电器控制线(低电平吸合) │
  22           * │                  │                            │
  23           * │  P3.2 ───────────┴──> 继电器常开触点2          │
  24           * │  (INT0)                                        │
  25           * │                                                │
  26           * │  P2.0 ─────────────────> 24C02-SDA (数据线)   │
  27           * │  P2.1 ─────────────────> 24C02-SCL (时钟线)   │
  28           * │                                                │
  29           * │  P2.3~P2.7 ───────────> 数码管显示控制         │
  30           * │                                                │
  31           * └─────────────────────────────────
             -───────────────┘
  32           */
  33          
  34          // 流量计参数
  35          static BYTE flowMode = FLOW_MODE_OFF;     // 流量显示模式
  36          static WORD pulseCount = 0;               // 当前流量脉冲计数
  37          static WORD currentFlow = 0;              // 当前流量值（毫升/秒）
  38          // 移除本地totalFlow声明，使用i2c.c中的全局变量
  39          // extern unsigned long totalFlow;          // 累计流量值（毫升）- 使用i2c.c中的全局变量
  40          static bit isRunning = 0;                 // 流量计运行状态
  41          static bit needUpdateDisplay = 0;         // 显示更新标志
  42          static BYTE initialDisplayDelay = 0;      // 初始显示延迟计数器
  43          
  44          // 24C02存储控制变量
  45          static BYTE saveCounter = 0;              // 定期保存计数器
  46          static bit totalFlowChanged = 0;          // 累计流量变化标志
  47          static unsigned long xdata lastSavedFlow = 0;   // 上次保存的累计流量 - 移到xdata
  48          
  49          // 流量计参数定义
  50          #define PULSE_FACTOR 1                   // 每个脉冲代表1毫升
  51          #define FLOW_UPDATE_INTERVAL 1           // 每秒更新一次流量值
  52          #define SAVE_INTERVAL 10                 // 每10秒保存一次到24C02
C51 COMPILER V9.54   FLOWMETER                                                             05/28/2025 12:20:34 PAGE 2   

  53          #define IMMEDIATE_SAVE_THRESHOLD 50      // 累计差值超过50ml立即保存
  54          
  55          // 流量计初始化
  56          void FlowMeter_Init(void) {
  57   1          /*
  58   1           * 硬件初始化说明：
  59   1           * - INT0 (P3.2): 设置为边沿触发，检测流量脉冲
  60   1           * - P1.0: 方波发生器输出，模拟水流传感器
  61   1           * - P1.1: 继电器控制，控制水阀开关
  62   1           * - P2.0/P2.1: I2C接口，连接24C02存储芯片
  63   1           */
  64   1          
  65   1      
  66   1          char flowStr[12];
  67   1          char temp[12];
  68   1          BYTE i = 0, j = 0;
  69   1          unsigned long tempFlow;
  70   1      
  71   1          IT0 = 1;                           // 设置INT0为边沿触发（下降沿触发）
  72   1          EX0 = 1;                           // 使能INT0中断
  73   1          pulseCount = 0;                    // 初始化脉冲计数
  74   1          currentFlow = 0;                   // 初始化当前流量
  75   1          
  76   1      
  77   1          
  78   1          // 从24C02读取累计流量数据
  79   1          totalFlow = AT24C02_ReadTotalFlow();
  80   1      
  81   1          lastSavedFlow = totalFlow;         // 立即保存原始值
  82   1          
  83   1          // 发送累计流量到串口进行调试
  84   1          UART_SendString("Total Flow: ");
  85   1          
  86   1          if(totalFlow == 0) {
  87   2              UART_SendString("0");
  88   2          } else {
  89   2              tempFlow = totalFlow;
  90   2              i = 0;  // 重置索引
  91   2              
  92   2              // 从低位到高位提取数字
  93   2              while(tempFlow > 0 && i < 10) {  // 添加边界检查
  94   3                  temp[i++] = '0' + (tempFlow % 10);
  95   3                  tempFlow /= 10;
  96   3              }
  97   2              
  98   2              // 确保至少有一个数字
  99   2              if(i == 0) {
 100   3                  temp[i++] = '0';
 101   3              }
 102   2              
 103   2              // 反转字符串
 104   2              j = 0;
 105   2              while(i > 0 && j < 10) {  // 添加边界检查
 106   3                  flowStr[j++] = temp[--i];
 107   3              }
 108   2              flowStr[j] = '\0';
 109   2              
 110   2              UART_SendString(flowStr);
 111   2          }
 112   1          
 113   1          UART_SendString(" ml\r\n");
 114   1          
C51 COMPILER V9.54   FLOWMETER                                                             05/28/2025 12:20:34 PAGE 3   

 115   1          isRunning = 0;                     // 初始不运行
 116   1          flowMode = FLOW_MODE_OFF;          // 默认显示模式为关闭
 117   1          saveCounter = 0;                   // 重置保存计数器
 118   1          totalFlowChanged = 0;              // 重置变化标志
 119   1      }
 120          
 121          // 启动流量计
 122          void FlowMeter_Start(void) {
 123   1          if (!isRunning) {
 124   2              pulseCount = 0;                // 重置脉冲计数
 125   2              EX0 = 1;                       // 使能INT0中断
 126   2              isRunning = 1;                 // 标记流量计开始运行
 127   2              
 128   2              // 设置初始非零流量值
 129   2              currentFlow = 0; 
 130   2              
 131   2              // 强制立即更新显示
 132   2              needUpdateDisplay = 1;
 133   2              initialDisplayDelay = 2;       // 设置初始显示延迟
 134   2          }
 135   1      }
 136          
 137          // 停止流量计
 138          void FlowMeter_Stop(void) {
 139   1          isRunning = 0;                     // 标记流量计停止
 140   1          // 不关闭中断，以便继续统计总流量
 141   1      }
 142          
 143          // 复位流量计累计值
 144          void FlowMeter_Reset(void) {
 145   1          pulseCount = 0;                    // 重置脉冲计数
 146   1          currentFlow = 0;                   // 重置当前流量
 147   1          // 注意：这里不重置totalFlow，因为累计流量应该是永久累计的
 148   1          // 如果需要重置累计流量，应该提供单独的函数
 149   1      }
 150          
 151          /*
 152           * ========================================
 153           * 流量计显示功能详细说明
 154           * ========================================
 155           * 
 156           * 【数码管显示模式】
 157           * ==================
 158           * 
 159           * 浇水过程中，数码管会在两种模式间自动切换显示：
 160           * 
 161           * 1. 当前流量显示模式 (FLOW_MODE_CURR)：
 162           *    ┌────────────────────────────────
             -────┐
 163           *    │ 显示格式：XXXXX10                   │
 164           *    │ 含义：当前瞬时流量，单位毫升/秒      │
 165           *    │ 示例："000510" = 5毫升/秒           │
 166           *    │ 右侧"10"标识当前流量模式            │
 167           *    └────────────────────────────────
             -────┘
 168           * 
 169           * 2. 累计流量显示模式 (FLOW_MODE_TOTAL)：
 170           *    ┌────────────────────────────────
             -────┐
 171           *    │ 显示格式：XXXXX11                   │
 172           *    │ 含义：累计总流量，单位毫升           │
 173           *    │ 示例："012311" = 123毫升总流量      │
C51 COMPILER V9.54   FLOWMETER                                                             05/28/2025 12:20:34 PAGE 4   

 174           *    │ 右侧"11"标识累计流量模式            │
 175           *    └────────────────────────────────
             -────┘
 176           * 
 177           * 【切换频率】
 178           * ============
 179           * - 每3秒自动切换一次显示模式
 180           * - 浇水期间持续轮流显示
 181           * - 停止浇水后关闭流量显示
 182           * 
 183           * 【定时浇水期间的显示】
 184           * ======================
 185           * 
 186           * 正在浇水时：
 187           * ┌─────────────────────────────────
             -───┐
 188           * │ 显示：剩余毫升数 "XXXX05"            │
 189           * │ 示例："007505" = 还需浇75毫升       │
 190           * │ 实时减少，直到变为"000005"           │
 191           * └─────────────────────────────────
             -───┘
 192           * 
 193           * 【流量计算原理】
 194           * ================
 195           * 
 196           * 脉冲计数：
 197           * - INT0下降沿触发中断
 198           * - 每个下降沿代表1毫升水流
 199           * - 5Hz频率 = 每秒5个脉冲 = 5毫升/秒
 200           * 
 201           * 累计流量：
 202           * - 每秒累加当前流量值
 203           * - 数据每10秒保存到24C02
 204           * - 断电后从24C02恢复数据
 205           * 
 206           * 【使用说明】
 207           * ============
 208           * 
 209           * 手动浇水时查看流量：
 210           * 1. 按P3.3开始手动浇水
 211           * 2. 观察数码管显示的当前流量和累计流量
 212           * 3. 再按P3.3停止浇水
 213           * 
 214           * 定时浇水时查看进度：
 215           * 1. 设置定时浇水并启动
 216           * 2. 浇水开始时观察剩余毫升数
 217           * 3. 数值逐渐减少到0时自动停止
 218           */
 219          
 220          /*
 221           * 数码管显示说明：
 222           * 浇水过程中数码管会轮流显示两种模式：当前流量和累计流量
 223           * 
 224           * 1. 当前流量显示模式（FLOW_MODE_CURR）:
 225           *    - 数码管从右到左依次为：位1-位6
 226           *    - 位1: 不显示
 227           *    - 位2: 显示数字"5"，表示当前为流量显示模式
 228           *    - 位3: 不显示
 229           *    - 位4-位6: 显示当前流量数值，单位为毫升/秒
 230           *      例如：显示"250 5 "表示当前流量为250毫升/秒
 231           * 
 232           * 2. 累计流量显示模式（FLOW_MODE_TOTAL）:
C51 COMPILER V9.54   FLOWMETER                                                             05/28/2025 12:20:34 PAGE 5   

 233           *    - 数码管从右到左依次为：位1-位6
 234           *    - 位1: 显示数字"1"，表示当前为累计流量显示模式
 235           *    - 位2-位6: 显示累计流量数值，单位为毫升
 236           *      例如：显示"23501"表示累计流量为2350毫升
 237           * 
 238           * 注：系统会每3秒在这两种显示模式间自动切换
 239           */
 240          
 241          // 计算流量（每秒调用一次，由中断触发）
 242          void FlowMeter_CalcFlow(void) {
 243   1          static BYTE updateCounter = 0;
 244   1          
 245   1          if (initialDisplayDelay > 0) {
 246   2              initialDisplayDelay--;
 247   2              if (initialDisplayDelay == 0) {
 248   3                  needUpdateDisplay = 1;
 249   3              }
 250   2          }
 251   1          
 252   1          // 每FLOW_UPDATE_INTERVAL秒更新一次当前流量
 253   1          if (++updateCounter >= FLOW_UPDATE_INTERVAL) {
 254   2              updateCounter = 0;
 255   2              
 256   2              if (isRunning) {
 257   3                  currentFlow = pulseCount;
 258   3                  
 259   3                  // 更新累计流量（毫升）
 260   3                  if (currentFlow > 0) {
 261   4                      unsigned long oldTotalFlow = totalFlow;
 262   4                      totalFlow += currentFlow;
 263   4                      
 264   4                      // 标记累计流量已改变
 265   4                      if (totalFlow != oldTotalFlow) {
 266   5                          totalFlowChanged = 1;
 267   5                      }
 268   4                      
 269   4                      // 检查是否需要立即保存（防止大量数据丢失）
 270   4                      if (totalFlow - lastSavedFlow >= IMMEDIATE_SAVE_THRESHOLD) {
 271   5                          SaveTotalFlowToEEPROM();
 272   5                      }
 273   4                  }
 274   3              }
 275   2              
 276   2              // 定期保存累计流量到24C02
 277   2              if (++saveCounter >= SAVE_INTERVAL) {
 278   3                  saveCounter = 0;
 279   3                  
 280   3                  // 只有当累计流量发生变化时才保存
 281   3                  if (totalFlowChanged) {
 282   4                      SaveTotalFlowToEEPROM();
 283   4                  }
 284   3              }
 285   2              
 286   2              // 重置脉冲计数，准备下次统计
 287   2              pulseCount = 0;
 288   2              needUpdateDisplay = 1;
 289   2          }
 290   1          
 291   1          // 轮流显示切换逻辑
 292   1          if (isRunning) {
 293   2              static BYTE displayToggle = 0;
 294   2              
C51 COMPILER V9.54   FLOWMETER                                                             05/28/2025 12:20:34 PAGE 6   

 295   2              if (++displayToggle >= 3) {  
 296   3                  displayToggle = 0;
 297   3                  flowMode = (flowMode == FLOW_MODE_CURR) ? FLOW_MODE_TOTAL : FLOW_MODE_CURR;
 298   3                  needUpdateDisplay = 1;
 299   3              }
 300   2          }
 301   1      }
 302          
 303          /*
 304           * ========================================
 305           * 24C02累计流量存储功能
 306           * ========================================
 307           * 
 308           * 【存储策略】
 309           * ============
 310           * 1. 定期保存：每10秒自动保存一次累计流量
 311           * 2. 即时保存：累计流量增加超过50ml时立即保存
 312           * 3. 智能保存：只有数据变化时才执行写入操作
 313           * 4. 掉电保护：断电重启后自动恢复累计流量数据
 314           * 
 315           * 【24C02地址分配】
 316           * ==================
 317           * 地址0x00-0x03: 累计流量数据 (4字节unsigned long)
 318           * 地址0x10-0x16: 定时浇水参数 (7字节)
 319           * 
 320           * 【数据格式】
 321           * ============
 322           * 累计流量按小端序存储：
 323           * - 0x00: 累计流量低字节  (totalFlow & 0xFF)
 324           * - 0x01: 累计流量第2字节 ((totalFlow >> 8) & 0xFF)  
 325           * - 0x02: 累计流量第3字节 ((totalFlow >> 16) & 0xFF)
 326           * - 0x03: 累计流量高字节  ((totalFlow >> 24) & 0xFF)
 327           */
 328          
 329          // 保存累计流量到24C02
 330          void SaveTotalFlowToEEPROM(void) {
 331   1          // 写入4字节累计流量数据到24C02
 332   1          AT24C02_WriteTotalFlow(totalFlow);
 333   1          
 334   1          // 更新保存状态
 335   1          lastSavedFlow = totalFlow;
 336   1          totalFlowChanged = 0;
 337   1          
 338   1          // 通过串口输出保存信息（调试用，可选）
 339   1          #ifdef DEBUG_FLOW_SAVE
                  UART_SendString("累计流量已保存: ");
                  // 这里可以添加数值转换和输出代码
                  UART_SendString("毫升\r\n");
                  #endif
 344   1      }
 345          
 346          // 检查并更新显示（在主循环中调用，不在中断中）
 347          void FlowMeter_UpdateDisplay(void) {
 348   1          if (needUpdateDisplay) {
 349   2              needUpdateDisplay = 0;  // 清除标志
 350   2              
 351   2              // 根据当前模式更新显示
 352   2              if (flowMode == FLOW_MODE_CURR) {
 353   3                  UpdateCurrentFlowDisplay();
 354   3              } else if (flowMode == FLOW_MODE_TOTAL) {
 355   3                  UpdateTotalFlowDisplay();
 356   3              }
C51 COMPILER V9.54   FLOWMETER                                                             05/28/2025 12:20:34 PAGE 7   

 357   2          }
 358   1      }
 359          
 360          // 更新当前流量显示
 361          void UpdateCurrentFlowDisplay(void) {
 362   1          BYTE val1, val2, val3, val4, val5, val6;
 363   1          
 364   1          // 提取当前流量各位数字（毫升/秒）
 365   1          WORD flow_display = currentFlow;  // currentFlow已经是毫升/秒的值
 366   1          
 367   1          // 构造显示数字 - 格式：XXXX毫升/秒
 368   1          val1 = 10;  // 10，表示当前流量显示模式
 369   1          val2 = (flow_display / 10000) % 10; // 万位（毫升/秒）
 370   1          val3 = (flow_display / 1000) % 10;  // 千位（毫升/秒）
 371   1          val4 = (flow_display / 100) % 10;   // 百位（毫升/秒）
 372   1          val5 = (flow_display / 10) % 10;    // 十位（毫升/秒）
 373   1          val6 = flow_display % 10;           // 个位（毫升/秒）
 374   1          
 375   1          // 直接填充显示缓冲区 - 显示格式如：250毫升/秒显示为"25010"
 376   1          FillCustomDispBuf(val6, val5, val4, val3, val2, val1);
 377   1      }
 378          
 379          // 更新累计流量显示
 380          void UpdateTotalFlowDisplay(void) {
 381   1          BYTE val1, val2, val3, val4, val5, val6;
 382   1          
 383   1          // 提取总流量各位数字（毫升）
 384   1          unsigned long flow_ml = totalFlow;  // 直接使用毫升值
 385   1          
 386   1          // 构造显示数字
 387   1          val1 = 11;  // 11,累计流量显示模式
 388   1          val2 = (BYTE)((flow_ml / 10000) % 10); // 万位（毫升）
 389   1          val3 = (BYTE)((flow_ml / 1000) % 10);  // 千位（毫升）
 390   1          val4 = (BYTE)((flow_ml / 100) % 10);   // 百位（毫升）
 391   1          val5 = (BYTE)((flow_ml / 10) % 10);    // 十位（毫升）
 392   1          val6 = (BYTE)(flow_ml % 10);           // 个位（毫升）
 393   1          
 394   1          // 直接填充显示缓冲区
 395   1          FillCustomDispBuf(val6, val5, val4, val3, val2, val1);
 396   1      }
 397          
 398          // 设置流量显示模式
 399          void FlowMeter_SetMode(BYTE mode) {
 400   1          flowMode = mode;
 401   1          
 402   1          // 仅设置更新标志，实际显示在主循环中执行
 403   1          needUpdateDisplay = 1;
 404   1      }
 405          
 406          // 获取当前流量显示模式
 407          BYTE FlowMeter_GetMode(void) {
 408   1          return flowMode;
 409   1      }
 410          
 411          // 获取累计流量
 412          unsigned long FlowMeter_GetTotalFlow(void) {
 413   1          return totalFlow;
 414   1      }
 415          
 416          // 外部中断0服务函数 - 用于脉冲计数
 417          void INT0_ISR() interrupt 0 {
 418   1          // 简单计数，每次下降沿中断增加计数
C51 COMPILER V9.54   FLOWMETER                                                             05/28/2025 12:20:34 PAGE 8   

 419   1          // 如果这里被调用太频繁，可能是：
 420   1          // 1. T0频率过高
 421   1          // 2. 继电器触点抖动
 422   1          // 3. 信号噪声
 423   1          pulseCount++;  // 每次中断增加脉冲计数
 424   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    962    ----
   CONSTANT SIZE    =     21    ----
   XDATA SIZE       =      4    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      9      48
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
