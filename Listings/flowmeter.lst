C51 COMPILER V9.54   FLOWMETER                                                             05/27/2025 21:42:52 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE FLOWMETER
OBJECT MODULE PLACED IN .\Objects\flowmeter.obj
COMPILER INVOKED BY: D:\Keil5\C51\BIN\C51.EXE flowmeter.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\f
                    -lowmeter.lst) OBJECT(.\Objects\flowmeter.obj)

line level    source

   1          #include "flowmeter.h"
   2          #include "intrins.h"
   3          #include "i2c.h"  
   4          #include "uart.h"
   5          
   6          /*
   7           * ========================================
   8           * æµé‡è®¡ç³»ç»Ÿ - ç¡¬ä»¶è¿æ¥è¯´æ˜
   9           * ========================================
  10           * 
  11           * ã€å¼•è„šè¿æ¥å›¾ã€‘
  12           * ==============
  13           * 
  14           * 51å•ç‰‡æœº                   å¤–è®¾è¿æ¥
  15           * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â
             -”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  16           * â”‚                                                 â”‚
  17           * â”‚  P1.0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
  18           * â”‚                  â”‚                            â”‚
  19           * â”‚                  â”œâ”€â”€> ç»§ç”µå™¨å¸¸å¼€è§¦ç‚¹1          â”‚
  20           * â”‚                  â”‚                            â”‚
  21           * â”‚  P1.1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€> ç»§ç”µå™¨æ§åˆ¶çº¿(ä½ç”µå¹³å¸åˆ) â”‚
  22           * â”‚                  â”‚                            â”‚
  23           * â”‚  P3.2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€> ç»§ç”µå™¨å¸¸å¼€è§¦ç‚¹2          â”‚
  24           * â”‚  (INT0)                                        â”‚
  25           * â”‚                                                â”‚
  26           * â”‚  P2.0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 24C02-SDA (æ•°æ®çº¿)   â”‚
  27           * â”‚  P2.1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 24C02-SCL (æ—¶é’Ÿçº¿)   â”‚
  28           * â”‚                                                â”‚
  29           * â”‚  P2.3~P2.7 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æ•°ç ç®¡æ˜¾ç¤ºæ§åˆ¶         â”‚
  30           * â”‚                                                â”‚
  31           * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â
             -”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  32           * 
  33           * ã€å·¥ä½œåŸç†è¯´æ˜ã€‘
  34           * ================
  35           * 
  36           * 1. æ–¹æ³¢å‘ç”Ÿå™¨ (P1.0):
  37           *    - è¾“å‡º5Hzæ ‡å‡†æ–¹æ³¢ä¿¡å·
  38           *    - æ¯ä¸ªè„‰å†²ä»£è¡¨1æ¯«å‡æ°´æµ
  39           *    - è¿æ¥åˆ°ç»§ç”µå™¨å¸¸å¼€è§¦ç‚¹çš„ä¸€ç«¯
  40           * 
  41           * 2. ç»§ç”µå™¨æ§åˆ¶ (P1.1):
  42           *    - ä½ç”µå¹³(0)æ—¶ç»§ç”µå™¨å¸åˆï¼Œæ°´é˜€å¼€å¯
  43           *    - é«˜ç”µå¹³(1)æ—¶ç»§ç”µå™¨æ–­å¼€ï¼Œæ°´é˜€å…³é—­
  44           *    - å¸åˆæ—¶P1.0ä¿¡å·ä¼ å¯¼åˆ°P3.2
  45           * 
  46           * 3. æµé‡è®¡è¾“å…¥ (P3.2/INT0):
  47           *    - å¤–éƒ¨ä¸­æ–­0è¾“å…¥ï¼Œä¸‹é™æ²¿è§¦å‘
  48           *    - è¿æ¥åˆ°ç»§ç”µå™¨å¸¸å¼€è§¦ç‚¹çš„å¦ä¸€ç«¯
  49           *    - ç»§ç”µå™¨é—­åˆæ—¶æ¥æ”¶æ¥è‡ªP1.0çš„è„‰å†²
  50           * 
  51           * 4. 24C02å­˜å‚¨å™¨ (P2.0/P2.1):
  52           *    - P2.0: SDAæ•°æ®çº¿ï¼ŒåŒå‘é€šä¿¡
C51 COMPILER V9.54   FLOWMETER                                                             05/27/2025 21:42:52 PAGE 2   

  53           *    - P2.1: SCLæ—¶é’Ÿçº¿ï¼Œæ§åˆ¶é€šä¿¡æ—¶åº
  54           *    - å­˜å‚¨ç´¯è®¡æµé‡æ•°æ®ï¼Œæ‰ç”µä¸ä¸¢å¤±
  55           * 
  56           * ã€ä¿¡å·ä¼ è¾“è·¯å¾„ã€‘
  57           * ================
  58           * 
  59           * æ­£å¸¸å·¥ä½œæ—¶ï¼š
  60           * P1.0(5Hzæ–¹æ³¢) â†’ ç»§ç”µå™¨è§¦ç‚¹1 â†’ ç»§ç”µå™¨è§¦ç‚¹2 â†’ P3.2(INT0ä¸­æ–­)
  61           *                      â†‘
  62           *                 P1.1æ§åˆ¶çº¿(ä½ç”µå¹³å¸åˆ)
  63           * 
  64           * åœæ­¢å·¥ä½œæ—¶ï¼š
  65           * P1.0(5Hzæ–¹æ³¢) â†’ ç»§ç”µå™¨è§¦ç‚¹1   X   ç»§ç”µå™¨è§¦ç‚¹2 â†’ P3.2(æ— ä¿¡å·)
  66           *                      â†‘
  67           *                 P1.1æ§åˆ¶çº¿(é«˜ç”µå¹³æ–­å¼€)
  68           */
  69          
  70          /*
  71           * ========================================
  72           * æµé‡è®¡æ˜¾ç¤ºåŠŸèƒ½è¯¦ç»†è¯´æ˜
  73           * ========================================
  74           * 
  75           * ã€æ•°ç ç®¡æ˜¾ç¤ºæ¨¡å¼ã€‘
  76           * ==================
  77           * 
  78           * æµ‡æ°´è¿‡ç¨‹ä¸­ï¼Œæ•°ç ç®¡ä¼šåœ¨ä¸¤ç§æ¨¡å¼é—´è‡ªåŠ¨åˆ‡æ¢æ˜¾ç¤ºï¼š
  79           * 
  80           * 1. å½“å‰æµé‡æ˜¾ç¤ºæ¨¡å¼ (FLOW_MODE_CURR)ï¼š
  81           *    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â
             -”€â”€â”€â”€â”€â”
  82           *    â”‚ æ˜¾ç¤ºæ ¼å¼ï¼šXXXXX10                   â”‚
  83           *    â”‚ å«ä¹‰ï¼šå½“å‰ç¬æ—¶æµé‡ï¼Œå•ä½æ¯«å‡/ç§’      â”‚
  84           *    â”‚ ç¤ºä¾‹ï¼š"000510" = 5æ¯«å‡/ç§’           â”‚
  85           *    â”‚ å³ä¾§"10"æ ‡è¯†å½“å‰æµé‡æ¨¡å¼            â”‚
  86           *    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â
             -”€â”€â”€â”€â”€â”˜
  87           * 
  88           * 2. ç´¯è®¡æµé‡æ˜¾ç¤ºæ¨¡å¼ (FLOW_MODE_TOTAL)ï¼š
  89           *    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â
             -”€â”€â”€â”€â”€â”
  90           *    â”‚ æ˜¾ç¤ºæ ¼å¼ï¼šXXXXX11                   â”‚
  91           *    â”‚ å«ä¹‰ï¼šç´¯è®¡æ€»æµé‡ï¼Œå•ä½æ¯«å‡           â”‚
  92           *    â”‚ ç¤ºä¾‹ï¼š"012311" = 123æ¯«å‡æ€»æµé‡      â”‚
  93           *    â”‚ å³ä¾§"11"æ ‡è¯†ç´¯è®¡æµé‡æ¨¡å¼            â”‚
  94           *    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â
             -”€â”€â”€â”€â”€â”˜
  95           * 
  96           * ã€åˆ‡æ¢é¢‘ç‡ã€‘
  97           * ============
  98           * - æ¯3ç§’è‡ªåŠ¨åˆ‡æ¢ä¸€æ¬¡æ˜¾ç¤ºæ¨¡å¼
  99           * - æµ‡æ°´æœŸé—´æŒç»­è½®æµæ˜¾ç¤º
 100           * - åœæ­¢æµ‡æ°´åå…³é—­æµé‡æ˜¾ç¤º
 101           * 
 102           * ã€å®šæ—¶æµ‡æ°´æœŸé—´çš„æ˜¾ç¤ºã€‘
 103           * ======================
 104           * 
 105           * æ­£åœ¨æµ‡æ°´æ—¶ï¼š
 106           * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â
             -”€â”€â”€â”€â”
 107           * â”‚ æ˜¾ç¤ºï¼šå‰©ä½™æ¯«å‡æ•° "XXXX05"            â”‚
 108           * â”‚ ç¤ºä¾‹ï¼š"007505" = è¿˜éœ€æµ‡75æ¯«å‡       â”‚
 109           * â”‚ å®æ—¶å‡å°‘ï¼Œç›´åˆ°å˜ä¸º"000005"           â”‚
C51 COMPILER V9.54   FLOWMETER                                                             05/27/2025 21:42:52 PAGE 3   

 110           * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â
             -”€â”€â”€â”€â”˜
 111           * 
 112           * ã€æµé‡è®¡ç®—åŸç†ã€‘
 113           * ================
 114           * 
 115           * è„‰å†²è®¡æ•°ï¼š
 116           * - INT0ä¸‹é™æ²¿è§¦å‘ä¸­æ–­
 117           * - æ¯ä¸ªä¸‹é™æ²¿ä»£è¡¨1æ¯«å‡æ°´æµ
 118           * - 5Hzé¢‘ç‡ = æ¯ç§’5ä¸ªè„‰å†² = 5æ¯«å‡/ç§’
 119           * 
 120           * ç´¯è®¡æµé‡ï¼š
 121           * - æ¯ç§’ç´¯åŠ å½“å‰æµé‡å€¼
 122           * - æ•°æ®æ¯10ç§’ä¿å­˜åˆ°24C02
 123           * - æ–­ç”µåä»24C02æ¢å¤æ•°æ®
 124           * 
 125           * ã€ä½¿ç”¨è¯´æ˜ã€‘
 126           * ============
 127           * 
 128           * æ‰‹åŠ¨æµ‡æ°´æ—¶æŸ¥çœ‹æµé‡ï¼š
 129           * 1. æŒ‰P3.3å¼€å§‹æ‰‹åŠ¨æµ‡æ°´
 130           * 2. è§‚å¯Ÿæ•°ç ç®¡æ˜¾ç¤ºçš„å½“å‰æµé‡å’Œç´¯è®¡æµé‡
 131           * 3. å†æŒ‰P3.3åœæ­¢æµ‡æ°´
 132           * 
 133           * å®šæ—¶æµ‡æ°´æ—¶æŸ¥çœ‹è¿›åº¦ï¼š
 134           * 1. è®¾ç½®å®šæ—¶æµ‡æ°´å¹¶å¯åŠ¨
 135           * 2. æµ‡æ°´å¼€å§‹æ—¶è§‚å¯Ÿå‰©ä½™æ¯«å‡æ•°
 136           * 3. æ•°å€¼é€æ¸å‡å°‘åˆ°0æ—¶è‡ªåŠ¨åœæ­¢
 137           */
 138          
 139          /*
 140           * æ•°ç ç®¡æ˜¾ç¤ºè¯´æ˜ï¼š
 141           * æµ‡æ°´è¿‡ç¨‹ä¸­æ•°ç ç®¡ä¼šè½®æµæ˜¾ç¤ºä¸¤ç§æ¨¡å¼ï¼šå½“å‰æµé‡å’Œç´¯è®¡æµé‡
 142           * 
 143           * 1. å½“å‰æµé‡æ˜¾ç¤ºæ¨¡å¼ï¼ˆFLOW_MODE_CURRï¼‰:
 144           *    - æ•°ç ç®¡ä»å³åˆ°å·¦ä¾æ¬¡ä¸ºï¼šä½1-ä½6
 145           *    - ä½1: ä¸æ˜¾ç¤º
 146           *    - ä½2: æ˜¾ç¤ºæ•°å­—"5"ï¼Œè¡¨ç¤ºå½“å‰ä¸ºæµé‡æ˜¾ç¤ºæ¨¡å¼
 147           *    - ä½3: ä¸æ˜¾ç¤º
 148           *    - ä½4-ä½6: æ˜¾ç¤ºå½“å‰æµé‡æ•°å€¼ï¼Œå•ä½ä¸ºæ¯«å‡/ç§’
 149           *      ä¾‹å¦‚ï¼šæ˜¾ç¤º"250 5 "è¡¨ç¤ºå½“å‰æµé‡ä¸º250æ¯«å‡/ç§’
 150           * 
 151           * 2. ç´¯è®¡æµé‡æ˜¾ç¤ºæ¨¡å¼ï¼ˆFLOW_MODE_TOTALï¼‰:
 152           *    - æ•°ç ç®¡ä»å³åˆ°å·¦ä¾æ¬¡ä¸ºï¼šä½1-ä½6
 153           *    - ä½1: æ˜¾ç¤ºæ•°å­—"1"ï¼Œè¡¨ç¤ºå½“å‰ä¸ºç´¯è®¡æµé‡æ˜¾ç¤ºæ¨¡å¼
 154           *    - ä½2-ä½6: æ˜¾ç¤ºç´¯è®¡æµé‡æ•°å€¼ï¼Œå•ä½ä¸ºæ¯«å‡
 155           *      ä¾‹å¦‚ï¼šæ˜¾ç¤º"23501"è¡¨ç¤ºç´¯è®¡æµé‡ä¸º2350æ¯«å‡
 156           * 
 157           * æ³¨ï¼šç³»ç»Ÿä¼šæ¯3ç§’åœ¨è¿™ä¸¤ç§æ˜¾ç¤ºæ¨¡å¼é—´è‡ªåŠ¨åˆ‡æ¢
 158           */
 159          
 160          // æµé‡è®¡å‚æ•°
 161          static BYTE flowMode = FLOW_MODE_OFF;     // æµé‡æ˜¾ç¤ºæ¨¡å¼
 162          static WORD pulseCount = 0;               // å½“å‰æµé‡è„‰å†²è®¡æ•°
 163          static WORD currentFlow = 0;              // å½“å‰æµé‡å€¼ï¼ˆæ¯«å‡/ç§’ï¼‰
 164          // ç§»é™¤æœ¬åœ°totalFlowå£°æ˜ï¼Œä½¿ç”¨i2c.cä¸­çš„å…¨å±€å˜é‡
 165          // extern unsigned long totalFlow;          // ç´¯è®¡æµé‡å€¼ï¼ˆæ¯«å‡ï¼‰- ä½¿ç”¨i2c.cä¸­çš„å…¨å±€å˜é‡
 166          static bit isRunning = 0;                 // æµé‡è®¡è¿è¡ŒçŠ¶æ€
 167          static bit needUpdateDisplay = 0;         // æ˜¾ç¤ºæ›´æ–°æ ‡å¿—
 168          static BYTE initialDisplayDelay = 0;      // åˆå§‹æ˜¾ç¤ºå»¶è¿Ÿè®¡æ•°å™¨
 169          
 170          // 24C02å­˜å‚¨æ§åˆ¶å˜é‡
C51 COMPILER V9.54   FLOWMETER                                                             05/27/2025 21:42:52 PAGE 4   

 171          static BYTE saveCounter = 0;              // å®šæœŸä¿å­˜è®¡æ•°å™¨
 172          static bit totalFlowChanged = 0;          // ç´¯è®¡æµé‡å˜åŒ–æ ‡å¿—
 173          static unsigned long xdata lastSavedFlow = 0;   // ä¸Šæ¬¡ä¿å­˜çš„ç´¯è®¡æµé‡ - ç§»åˆ°xdata
 174          
 175          // æµé‡è®¡å‚æ•°å®šä¹‰
 176          #define PULSE_FACTOR 1                   // æ¯ä¸ªè„‰å†²ä»£è¡¨1æ¯«å‡
 177          #define FLOW_UPDATE_INTERVAL 1           // æ¯ç§’æ›´æ–°ä¸€æ¬¡æµé‡å€¼
 178          #define SAVE_INTERVAL 10                 // æ¯10ç§’ä¿å­˜ä¸€æ¬¡åˆ°24C02
 179          #define IMMEDIATE_SAVE_THRESHOLD 50      // ç´¯è®¡å·®å€¼è¶…è¿‡50mlç«‹å³ä¿å­˜
 180          
 181          // æµé‡è®¡åˆå§‹åŒ–
 182          void FlowMeter_Init(void) {
 183   1          /*
 184   1           * ç¡¬ä»¶åˆå§‹åŒ–è¯´æ˜ï¼š
 185   1           * - INT0 (P3.2): è®¾ç½®ä¸ºè¾¹æ²¿è§¦å‘ï¼Œæ£€æµ‹æµé‡è„‰å†²
 186   1           * - P1.0: æ–¹æ³¢å‘ç”Ÿå™¨è¾“å‡ºï¼Œæ¨¡æ‹Ÿæ°´æµä¼ æ„Ÿå™¨
 187   1           * - P1.1: ç»§ç”µå™¨æ§åˆ¶ï¼Œæ§åˆ¶æ°´é˜€å¼€å…³
 188   1           * - P2.0/P2.1: I2Cæ¥å£ï¼Œè¿æ¥24C02å­˜å‚¨èŠ¯ç‰‡
 189   1           */
 190   1          
 191   1      
 192   1          char flowStr[12];
 193   1          char temp[12];
 194   1          BYTE i = 0, j = 0;
 195   1          unsigned long tempFlow;
 196   1      
 197   1          IT0 = 1;                           // è®¾ç½®INT0ä¸ºè¾¹æ²¿è§¦å‘ï¼ˆä¸‹é™æ²¿è§¦å‘ï¼‰
 198   1          EX0 = 1;                           // ä½¿èƒ½INT0ä¸­æ–­
 199   1          pulseCount = 0;                    // åˆå§‹åŒ–è„‰å†²è®¡æ•°
 200   1          currentFlow = 0;                   // åˆå§‹åŒ–å½“å‰æµé‡
 201   1          
 202   1      
 203   1          
 204   1          // ä»24C02è¯»å–ç´¯è®¡æµé‡æ•°æ®
 205   1          totalFlow = AT24C02_ReadTotalFlow();
 206   1      
 207   1          lastSavedFlow = totalFlow;         // ç«‹å³ä¿å­˜åŸå§‹å€¼
 208   1          
 209   1          // å‘é€ç´¯è®¡æµé‡åˆ°ä¸²å£è¿›è¡Œè°ƒè¯•
 210   1          UART_SendString("Total Flow: ");
 211   1          
 212   1          if(totalFlow == 0) {
 213   2              UART_SendString("0");
 214   2          } else {
 215   2              tempFlow = totalFlow;
 216   2              i = 0;  // é‡ç½®ç´¢å¼•
 217   2              
 218   2              // ä»ä½ä½åˆ°é«˜ä½æå–æ•°å­—
 219   2              while(tempFlow > 0 && i < 10) {  // æ·»åŠ è¾¹ç•Œæ£€æŸ¥
 220   3                  temp[i++] = '0' + (tempFlow % 10);
 221   3                  tempFlow /= 10;
 222   3              }
 223   2              
 224   2              // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªæ•°å­—
 225   2              if(i == 0) {
 226   3                  temp[i++] = '0';
 227   3              }
 228   2              
 229   2              // åè½¬å­—ç¬¦ä¸²
 230   2              j = 0;
 231   2              while(i > 0 && j < 10) {  // æ·»åŠ è¾¹ç•Œæ£€æŸ¥
 232   3                  flowStr[j++] = temp[--i];
C51 COMPILER V9.54   FLOWMETER                                                             05/27/2025 21:42:52 PAGE 5   

 233   3              }
 234   2              flowStr[j] = '\0';
 235   2              
 236   2              UART_SendString(flowStr);
 237   2          }
 238   1          
 239   1          UART_SendString(" ml\r\n");
 240   1          
 241   1          isRunning = 0;                     // åˆå§‹ä¸è¿è¡Œ
 242   1          flowMode = FLOW_MODE_OFF;          // é»˜è®¤æ˜¾ç¤ºæ¨¡å¼ä¸ºå…³é—­
 243   1          saveCounter = 0;                   // é‡ç½®ä¿å­˜è®¡æ•°å™¨
 244   1          totalFlowChanged = 0;              // é‡ç½®å˜åŒ–æ ‡å¿—
 245   1      }
 246          
 247          // å¯åŠ¨æµé‡è®¡
 248          void FlowMeter_Start(void) {
 249   1          if (!isRunning) {
 250   2              pulseCount = 0;                // é‡ç½®è„‰å†²è®¡æ•°
 251   2              EX0 = 1;                       // ä½¿èƒ½INT0ä¸­æ–­
 252   2              isRunning = 1;                 // æ ‡è®°æµé‡è®¡å¼€å§‹è¿è¡Œ
 253   2              
 254   2              // è®¾ç½®åˆå§‹éé›¶æµé‡å€¼
 255   2              currentFlow = 0; 
 256   2              
 257   2              // å¼ºåˆ¶ç«‹å³æ›´æ–°æ˜¾ç¤º
 258   2              needUpdateDisplay = 1;
 259   2              initialDisplayDelay = 2;       // è®¾ç½®åˆå§‹æ˜¾ç¤ºå»¶è¿Ÿ
 260   2          }
 261   1      }
 262          
 263          // åœæ­¢æµé‡è®¡
 264          void FlowMeter_Stop(void) {
 265   1          isRunning = 0;                     // æ ‡è®°æµé‡è®¡åœæ­¢
 266   1          // ä¸å…³é—­ä¸­æ–­ï¼Œä»¥ä¾¿ç»§ç»­ç»Ÿè®¡æ€»æµé‡
 267   1      }
 268          
 269          // å¤ä½æµé‡è®¡ç´¯è®¡å€¼
 270          void FlowMeter_Reset(void) {
 271   1          pulseCount = 0;                    // é‡ç½®è„‰å†²è®¡æ•°
 272   1          currentFlow = 0;                   // é‡ç½®å½“å‰æµé‡
 273   1          // æ³¨æ„ï¼šè¿™é‡Œä¸é‡ç½®totalFlowï¼Œå› ä¸ºç´¯è®¡æµé‡åº”è¯¥æ˜¯æ°¸ä¹…ç´¯è®¡çš„
 274   1          // å¦‚æœéœ€è¦é‡ç½®ç´¯è®¡æµé‡ï¼Œåº”è¯¥æä¾›å•ç‹¬çš„å‡½æ•°
 275   1      }
 276          
 277          // æ–°å¢ï¼šé‡ç½®ç´¯è®¡æµé‡ï¼ˆåŒæ—¶æ¸…é™¤24C02ä¸­çš„æ•°æ®ï¼‰
 278          void FlowMeter_ResetTotal(void) {
 279   1          totalFlow = 0;
 280   1          AT24C02_WriteTotalFlow(0);
 281   1      }
 282          
 283          /*
 284           * ========================================
 285           * æµé‡è®¡æ˜¾ç¤ºåŠŸèƒ½è¯¦ç»†è¯´æ˜
 286           * ========================================
 287           * 
 288           * ã€æ•°ç ç®¡æ˜¾ç¤ºæ¨¡å¼ã€‘
 289           * ==================
 290           * 
 291           * æµ‡æ°´è¿‡ç¨‹ä¸­ï¼Œæ•°ç ç®¡ä¼šåœ¨ä¸¤ç§æ¨¡å¼é—´è‡ªåŠ¨åˆ‡æ¢æ˜¾ç¤ºï¼š
 292           * 
 293           * 1. å½“å‰æµé‡æ˜¾ç¤ºæ¨¡å¼ (FLOW_MODE_CURR)ï¼š
 294           *    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â
C51 COMPILER V9.54   FLOWMETER                                                             05/27/2025 21:42:52 PAGE 6   

             -”€â”€â”€â”€â”€â”
 295           *    â”‚ æ˜¾ç¤ºæ ¼å¼ï¼šXXXXX10                   â”‚
 296           *    â”‚ å«ä¹‰ï¼šå½“å‰ç¬æ—¶æµé‡ï¼Œå•ä½æ¯«å‡/ç§’      â”‚
 297           *    â”‚ ç¤ºä¾‹ï¼š"000510" = 5æ¯«å‡/ç§’           â”‚
 298           *    â”‚ å³ä¾§"10"æ ‡è¯†å½“å‰æµé‡æ¨¡å¼            â”‚
 299           *    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â
             -”€â”€â”€â”€â”€â”˜
 300           * 
 301           * 2. ç´¯è®¡æµé‡æ˜¾ç¤ºæ¨¡å¼ (FLOW_MODE_TOTAL)ï¼š
 302           *    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â
             -”€â”€â”€â”€â”€â”
 303           *    â”‚ æ˜¾ç¤ºæ ¼å¼ï¼šXXXXX11                   â”‚
 304           *    â”‚ å«ä¹‰ï¼šç´¯è®¡æ€»æµé‡ï¼Œå•ä½æ¯«å‡           â”‚
 305           *    â”‚ ç¤ºä¾‹ï¼š"012311" = 123æ¯«å‡æ€»æµé‡      â”‚
 306           *    â”‚ å³ä¾§"11"æ ‡è¯†ç´¯è®¡æµé‡æ¨¡å¼            â”‚
 307           *    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â
             -”€â”€â”€â”€â”€â”˜
 308           * 
 309           * ã€åˆ‡æ¢é¢‘ç‡ã€‘
 310           * ============
 311           * - æ¯3ç§’è‡ªåŠ¨åˆ‡æ¢ä¸€æ¬¡æ˜¾ç¤ºæ¨¡å¼
 312           * - æµ‡æ°´æœŸé—´æŒç»­è½®æµæ˜¾ç¤º
 313           * - åœæ­¢æµ‡æ°´åå…³é—­æµé‡æ˜¾ç¤º
 314           * 
 315           * ã€å®šæ—¶æµ‡æ°´æœŸé—´çš„æ˜¾ç¤ºã€‘
 316           * ======================
 317           * 
 318           * æ­£åœ¨æµ‡æ°´æ—¶ï¼š
 319           * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â
             -”€â”€â”€â”€â”
 320           * â”‚ æ˜¾ç¤ºï¼šå‰©ä½™æ¯«å‡æ•° "XXXX05"            â”‚
 321           * â”‚ ç¤ºä¾‹ï¼š"007505" = è¿˜éœ€æµ‡75æ¯«å‡       â”‚
 322           * â”‚ å®æ—¶å‡å°‘ï¼Œç›´åˆ°å˜ä¸º"000005"           â”‚
 323           * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â
             -”€â”€â”€â”€â”˜
 324           * 
 325           * ã€æµé‡è®¡ç®—åŸç†ã€‘
 326           * ================
 327           * 
 328           * è„‰å†²è®¡æ•°ï¼š
 329           * - INT0ä¸‹é™æ²¿è§¦å‘ä¸­æ–­
 330           * - æ¯ä¸ªä¸‹é™æ²¿ä»£è¡¨1æ¯«å‡æ°´æµ
 331           * - 5Hzé¢‘ç‡ = æ¯ç§’5ä¸ªè„‰å†² = 5æ¯«å‡/ç§’
 332           * 
 333           * ç´¯è®¡æµé‡ï¼š
 334           * - æ¯ç§’ç´¯åŠ å½“å‰æµé‡å€¼
 335           * - æ•°æ®æ¯10ç§’ä¿å­˜åˆ°24C02
 336           * - æ–­ç”µåä»24C02æ¢å¤æ•°æ®
 337           * 
 338           * ã€ä½¿ç”¨è¯´æ˜ã€‘
 339           * ============
 340           * 
 341           * æ‰‹åŠ¨æµ‡æ°´æ—¶æŸ¥çœ‹æµé‡ï¼š
 342           * 1. æŒ‰P3.3å¼€å§‹æ‰‹åŠ¨æµ‡æ°´
 343           * 2. è§‚å¯Ÿæ•°ç ç®¡æ˜¾ç¤ºçš„å½“å‰æµé‡å’Œç´¯è®¡æµé‡
 344           * 3. å†æŒ‰P3.3åœæ­¢æµ‡æ°´
 345           * 
 346           * å®šæ—¶æµ‡æ°´æ—¶æŸ¥çœ‹è¿›åº¦ï¼š
 347           * 1. è®¾ç½®å®šæ—¶æµ‡æ°´å¹¶å¯åŠ¨
 348           * 2. æµ‡æ°´å¼€å§‹æ—¶è§‚å¯Ÿå‰©ä½™æ¯«å‡æ•°
 349           * 3. æ•°å€¼é€æ¸å‡å°‘åˆ°0æ—¶è‡ªåŠ¨åœæ­¢
 350           */
C51 COMPILER V9.54   FLOWMETER                                                             05/27/2025 21:42:52 PAGE 7   

 351          
 352          /*
 353           * æ•°ç ç®¡æ˜¾ç¤ºè¯´æ˜ï¼š
 354           * æµ‡æ°´è¿‡ç¨‹ä¸­æ•°ç ç®¡ä¼šè½®æµæ˜¾ç¤ºä¸¤ç§æ¨¡å¼ï¼šå½“å‰æµé‡å’Œç´¯è®¡æµé‡
 355           * 
 356           * 1. å½“å‰æµé‡æ˜¾ç¤ºæ¨¡å¼ï¼ˆFLOW_MODE_CURRï¼‰:
 357           *    - æ•°ç ç®¡ä»å³åˆ°å·¦ä¾æ¬¡ä¸ºï¼šä½1-ä½6
 358           *    - ä½1: ä¸æ˜¾ç¤º
 359           *    - ä½2: æ˜¾ç¤ºæ•°å­—"5"ï¼Œè¡¨ç¤ºå½“å‰ä¸ºæµé‡æ˜¾ç¤ºæ¨¡å¼
 360           *    - ä½3: ä¸æ˜¾ç¤º
 361           *    - ä½4-ä½6: æ˜¾ç¤ºå½“å‰æµé‡æ•°å€¼ï¼Œå•ä½ä¸ºæ¯«å‡/ç§’
 362           *      ä¾‹å¦‚ï¼šæ˜¾ç¤º"250 5 "è¡¨ç¤ºå½“å‰æµé‡ä¸º250æ¯«å‡/ç§’
 363           * 
 364           * 2. ç´¯è®¡æµé‡æ˜¾ç¤ºæ¨¡å¼ï¼ˆFLOW_MODE_TOTALï¼‰:
 365           *    - æ•°ç ç®¡ä»å³åˆ°å·¦ä¾æ¬¡ä¸ºï¼šä½1-ä½6
 366           *    - ä½1: æ˜¾ç¤ºæ•°å­—"1"ï¼Œè¡¨ç¤ºå½“å‰ä¸ºç´¯è®¡æµé‡æ˜¾ç¤ºæ¨¡å¼
 367           *    - ä½2-ä½6: æ˜¾ç¤ºç´¯è®¡æµé‡æ•°å€¼ï¼Œå•ä½ä¸ºæ¯«å‡
 368           *      ä¾‹å¦‚ï¼šæ˜¾ç¤º"23501"è¡¨ç¤ºç´¯è®¡æµé‡ä¸º2350æ¯«å‡
 369           * 
 370           * æ³¨ï¼šç³»ç»Ÿä¼šæ¯3ç§’åœ¨è¿™ä¸¤ç§æ˜¾ç¤ºæ¨¡å¼é—´è‡ªåŠ¨åˆ‡æ¢
 371           */
 372          
 373          // è®¡ç®—æµé‡ï¼ˆæ¯ç§’è°ƒç”¨ä¸€æ¬¡ï¼Œç”±ä¸­æ–­è§¦å‘ï¼‰
 374          void FlowMeter_CalcFlow(void) {
 375   1          static BYTE updateCounter = 0;
 376   1          
 377   1          if (initialDisplayDelay > 0) {
 378   2              initialDisplayDelay--;
 379   2              if (initialDisplayDelay == 0) {
 380   3                  needUpdateDisplay = 1;
 381   3              }
 382   2          }
 383   1          
 384   1          // æ¯FLOW_UPDATE_INTERVALç§’æ›´æ–°ä¸€æ¬¡å½“å‰æµé‡
 385   1          if (++updateCounter >= FLOW_UPDATE_INTERVAL) {
 386   2              updateCounter = 0;
 387   2              
 388   2              if (isRunning) {
 389   3                  currentFlow = pulseCount;
 390   3                  
 391   3                  // æ›´æ–°ç´¯è®¡æµé‡ï¼ˆæ¯«å‡ï¼‰
 392   3                  if (currentFlow > 0) {
 393   4                      unsigned long oldTotalFlow = totalFlow;
 394   4                      totalFlow += currentFlow;
 395   4                      
 396   4                      // æ ‡è®°ç´¯è®¡æµé‡å·²æ”¹å˜
 397   4                      if (totalFlow != oldTotalFlow) {
 398   5                          totalFlowChanged = 1;
 399   5                      }
 400   4                      
 401   4                      // æ£€æŸ¥æ˜¯å¦éœ€è¦ç«‹å³ä¿å­˜ï¼ˆé˜²æ­¢å¤§é‡æ•°æ®ä¸¢å¤±ï¼‰
 402   4                      if (totalFlow - lastSavedFlow >= IMMEDIATE_SAVE_THRESHOLD) {
 403   5                          SaveTotalFlowToEEPROM();
 404   5                      }
 405   4                  }
 406   3              }
 407   2              
 408   2              // å®šæœŸä¿å­˜ç´¯è®¡æµé‡åˆ°24C02
 409   2              if (++saveCounter >= SAVE_INTERVAL) {
 410   3                  saveCounter = 0;
 411   3                  
 412   3                  // åªæœ‰å½“ç´¯è®¡æµé‡å‘ç”Ÿå˜åŒ–æ—¶æ‰ä¿å­˜
C51 COMPILER V9.54   FLOWMETER                                                             05/27/2025 21:42:52 PAGE 8   

 413   3                  if (totalFlowChanged) {
 414   4                      SaveTotalFlowToEEPROM();
 415   4                  }
 416   3              }
 417   2              
 418   2              // é‡ç½®è„‰å†²è®¡æ•°ï¼Œå‡†å¤‡ä¸‹æ¬¡ç»Ÿè®¡
 419   2              pulseCount = 0;
 420   2              needUpdateDisplay = 1;
 421   2          }
 422   1          
 423   1          // è½®æµæ˜¾ç¤ºåˆ‡æ¢é€»è¾‘
 424   1          if (isRunning) {
 425   2              static BYTE displayToggle = 0;
 426   2              
 427   2              if (++displayToggle >= 3) {  
 428   3                  displayToggle = 0;
 429   3                  flowMode = (flowMode == FLOW_MODE_CURR) ? FLOW_MODE_TOTAL : FLOW_MODE_CURR;
 430   3                  needUpdateDisplay = 1;
 431   3              }
 432   2          }
 433   1      }
 434          
 435          /*
 436           * ========================================
 437           * 24C02ç´¯è®¡æµé‡å­˜å‚¨åŠŸèƒ½
 438           * ========================================
 439           * 
 440           * ã€å­˜å‚¨ç­–ç•¥ã€‘
 441           * ============
 442           * 1. å®šæœŸä¿å­˜ï¼šæ¯10ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡ç´¯è®¡æµé‡
 443           * 2. å³æ—¶ä¿å­˜ï¼šç´¯è®¡æµé‡å¢åŠ è¶…è¿‡50mlæ—¶ç«‹å³ä¿å­˜
 444           * 3. æ™ºèƒ½ä¿å­˜ï¼šåªæœ‰æ•°æ®å˜åŒ–æ—¶æ‰æ‰§è¡Œå†™å…¥æ“ä½œ
 445           * 4. æ‰ç”µä¿æŠ¤ï¼šæ–­ç”µé‡å¯åè‡ªåŠ¨æ¢å¤ç´¯è®¡æµé‡æ•°æ®
 446           * 
 447           * ã€24C02åœ°å€åˆ†é…ã€‘
 448           * ==================
 449           * åœ°å€0x00-0x03: ç´¯è®¡æµé‡æ•°æ® (4å­—èŠ‚unsigned long)
 450           * åœ°å€0x10-0x16: å®šæ—¶æµ‡æ°´å‚æ•° (7å­—èŠ‚)
 451           * 
 452           * ã€æ•°æ®æ ¼å¼ã€‘
 453           * ============
 454           * ç´¯è®¡æµé‡æŒ‰å°ç«¯åºå­˜å‚¨ï¼š
 455           * - 0x00: ç´¯è®¡æµé‡ä½å­—èŠ‚  (totalFlow & 0xFF)
 456           * - 0x01: ç´¯è®¡æµé‡ç¬¬2å­—èŠ‚ ((totalFlow >> 8) & 0xFF)  
 457           * - 0x02: ç´¯è®¡æµé‡ç¬¬3å­—èŠ‚ ((totalFlow >> 16) & 0xFF)
 458           * - 0x03: ç´¯è®¡æµé‡é«˜å­—èŠ‚  ((totalFlow >> 24) & 0xFF)
 459           */
 460          
 461          // ä¿å­˜ç´¯è®¡æµé‡åˆ°24C02
 462          void SaveTotalFlowToEEPROM(void) {
 463   1          // å†™å…¥4å­—èŠ‚ç´¯è®¡æµé‡æ•°æ®åˆ°24C02
 464   1          AT24C02_WriteTotalFlow(totalFlow);
 465   1          
 466   1          // æ›´æ–°ä¿å­˜çŠ¶æ€
 467   1          lastSavedFlow = totalFlow;
 468   1          totalFlowChanged = 0;
 469   1          
 470   1          // é€šè¿‡ä¸²å£è¾“å‡ºä¿å­˜ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼Œå¯é€‰ï¼‰
 471   1          #ifdef DEBUG_FLOW_SAVE
                  UART_SendString("ç´¯è®¡æµé‡å·²ä¿å­˜: ");
                  // è¿™é‡Œå¯ä»¥æ·»åŠ æ•°å€¼è½¬æ¢å’Œè¾“å‡ºä»£ç 
                  UART_SendString("æ¯«å‡\r\n");
C51 COMPILER V9.54   FLOWMETER                                                             05/27/2025 21:42:52 PAGE 9   

                  #endif
 476   1      }
 477          
 478          // ä»24C02è¯»å–ç´¯è®¡æµé‡
 479          unsigned long LoadTotalFlowFromEEPROM(void) {
 480   1          unsigned long loadedFlow = AT24C02_ReadTotalFlow();
 481   1          
 482   1          // æ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥ï¼ˆé˜²æ­¢è¯»å–åˆ°æ— æ•ˆæ•°æ®ï¼‰
 483   1          if (loadedFlow > 999999) {  // å¦‚æœç´¯è®¡æµé‡è¶…è¿‡999å‡ï¼Œè®¤ä¸ºæ•°æ®å¼‚å¸¸
 484   2              loadedFlow = 0;         // é‡ç½®ä¸º0
 485   2              AT24C02_WriteTotalFlow(0); // æ¸…é›¶24C02ä¸­çš„æ•°æ®
 486   2          }
 487   1          
 488   1          return loadedFlow;
 489   1      }
 490          
 491          // å¼ºåˆ¶ä¿å­˜å½“å‰ç´¯è®¡æµé‡ï¼ˆå¤–éƒ¨è°ƒç”¨ï¼‰
 492          void FlowMeter_ForceSave(void) {
 493   1          SaveTotalFlowToEEPROM();
 494   1      }
 495          
 496          // è·å–ä¸Šæ¬¡ä¿å­˜æ—¶é—´ç‚¹çš„ç´¯è®¡æµé‡
 497          unsigned long FlowMeter_GetLastSavedFlow(void) {
 498   1          return lastSavedFlow;
 499   1      }
 500          
 501          // æ£€æŸ¥ç´¯è®¡æµé‡æ˜¯å¦æœ‰æœªä¿å­˜çš„å˜åŒ–
 502          bit FlowMeter_HasUnsavedChanges(void) {
 503   1          return totalFlowChanged;
 504   1      }
 505          
 506          // æ£€æŸ¥å¹¶æ›´æ–°æ˜¾ç¤ºï¼ˆåœ¨ä¸»å¾ªç¯ä¸­è°ƒç”¨ï¼Œä¸åœ¨ä¸­æ–­ä¸­ï¼‰
 507          void FlowMeter_UpdateDisplay(void) {
 508   1          if (needUpdateDisplay) {
 509   2              needUpdateDisplay = 0;  // æ¸…é™¤æ ‡å¿—
 510   2              
 511   2              // æ ¹æ®å½“å‰æ¨¡å¼æ›´æ–°æ˜¾ç¤º
 512   2              if (flowMode == FLOW_MODE_CURR) {
 513   3                  UpdateCurrentFlowDisplay();
 514   3              } else if (flowMode == FLOW_MODE_TOTAL) {
 515   3                  UpdateTotalFlowDisplay();
 516   3              }
 517   2          }
 518   1      }
 519          
 520          // æ›´æ–°å½“å‰æµé‡æ˜¾ç¤º
 521          void UpdateCurrentFlowDisplay(void) {
 522   1          BYTE val1, val2, val3, val4, val5, val6;
 523   1          
 524   1          // æå–å½“å‰æµé‡å„ä½æ•°å­—ï¼ˆæ¯«å‡/ç§’ï¼‰
 525   1          WORD flow_display = currentFlow;  // currentFlowå·²ç»æ˜¯æ¯«å‡/ç§’çš„å€¼
 526   1          
 527   1          // æ„é€ æ˜¾ç¤ºæ•°å­— - æ ¼å¼ï¼šXXXXæ¯«å‡/ç§’
 528   1          val1 = 10;  // 10ï¼Œè¡¨ç¤ºå½“å‰æµé‡æ˜¾ç¤ºæ¨¡å¼
 529   1          val2 = (flow_display / 10000) % 10; // ä¸‡ä½ï¼ˆæ¯«å‡/ç§’ï¼‰
 530   1          val3 = (flow_display / 1000) % 10;  // åƒä½ï¼ˆæ¯«å‡/ç§’ï¼‰
 531   1          val4 = (flow_display / 100) % 10;   // ç™¾ä½ï¼ˆæ¯«å‡/ç§’ï¼‰
 532   1          val5 = (flow_display / 10) % 10;    // åä½ï¼ˆæ¯«å‡/ç§’ï¼‰
 533   1          val6 = flow_display % 10;           // ä¸ªä½ï¼ˆæ¯«å‡/ç§’ï¼‰
 534   1          
 535   1          // ç›´æ¥å¡«å……æ˜¾ç¤ºç¼“å†²åŒº - æ˜¾ç¤ºæ ¼å¼å¦‚ï¼š250æ¯«å‡/ç§’æ˜¾ç¤ºä¸º"25010"
 536   1          FillCustomDispBuf(val6, val5, val4, val3, val2, val1);
C51 COMPILER V9.54   FLOWMETER                                                             05/27/2025 21:42:52 PAGE 10  

 537   1      }
 538          
 539          // æ›´æ–°ç´¯è®¡æµé‡æ˜¾ç¤º
 540          void UpdateTotalFlowDisplay(void) {
 541   1          BYTE val1, val2, val3, val4, val5, val6;
 542   1          
 543   1          // æå–æ€»æµé‡å„ä½æ•°å­—ï¼ˆæ¯«å‡ï¼‰
 544   1          unsigned long flow_ml = totalFlow;  // ç›´æ¥ä½¿ç”¨æ¯«å‡å€¼
 545   1          
 546   1          // æ„é€ æ˜¾ç¤ºæ•°å­—
 547   1          val1 = 11;  // 11,ç´¯è®¡æµé‡æ˜¾ç¤ºæ¨¡å¼
 548   1          val2 = (BYTE)((flow_ml / 10000) % 10); // ä¸‡ä½ï¼ˆæ¯«å‡ï¼‰
 549   1          val3 = (BYTE)((flow_ml / 1000) % 10);  // åƒä½ï¼ˆæ¯«å‡ï¼‰
 550   1          val4 = (BYTE)((flow_ml / 100) % 10);   // ç™¾ä½ï¼ˆæ¯«å‡ï¼‰
 551   1          val5 = (BYTE)((flow_ml / 10) % 10);    // åä½ï¼ˆæ¯«å‡ï¼‰
 552   1          val6 = (BYTE)(flow_ml % 10);           // ä¸ªä½ï¼ˆæ¯«å‡ï¼‰
 553   1          
 554   1          // ç›´æ¥å¡«å……æ˜¾ç¤ºç¼“å†²åŒº
 555   1          FillCustomDispBuf(val6, val5, val4, val3, val2, val1);
 556   1      }
 557          
 558          // æ˜¾ç¤ºå½“å‰æµé‡ï¼ˆè¿™ä¸ªå‡½æ•°ä»…ä¾›å¤–éƒ¨è°ƒç”¨ï¼Œä¸åœ¨å†…éƒ¨è°ƒç”¨é“¾ä¸­ä½¿ç”¨ï¼‰
 559          void FlowMeter_DisplayCurrent(void) {
 560   1          UpdateCurrentFlowDisplay();
 561   1      }
 562          
 563          // æ˜¾ç¤ºç´¯è®¡æµé‡ï¼ˆè¿™ä¸ªå‡½æ•°ä»…ä¾›å¤–éƒ¨è°ƒç”¨ï¼Œä¸åœ¨å†…éƒ¨è°ƒç”¨é“¾ä¸­ä½¿ç”¨ï¼‰
 564          void FlowMeter_DisplayTotal(void) {
 565   1          UpdateTotalFlowDisplay();
 566   1      }
 567          
 568          // è®¾ç½®æµé‡æ˜¾ç¤ºæ¨¡å¼
 569          void FlowMeter_SetMode(BYTE mode) {
 570   1          flowMode = mode;
 571   1          
 572   1          // ä»…è®¾ç½®æ›´æ–°æ ‡å¿—ï¼Œå®é™…æ˜¾ç¤ºåœ¨ä¸»å¾ªç¯ä¸­æ‰§è¡Œ
 573   1          needUpdateDisplay = 1;
 574   1      }
 575          
 576          // è·å–å½“å‰æµé‡æ˜¾ç¤ºæ¨¡å¼
 577          BYTE FlowMeter_GetMode(void) {
 578   1          return flowMode;
 579   1      }
 580          
 581          // è·å–å½“å‰æµé‡
 582          WORD FlowMeter_GetCurrentFlow(void) {
 583   1          // è¿”å›å®é™…çš„æ¯«å‡/ç§’å€¼ï¼Œç”¨äºå®šæ—¶æµ‡æ°´è®¡ç®—
 584   1          return currentFlow;  // ç›´æ¥è¿”å›æ¯«å‡/ç§’å€¼
 585   1      }
 586          
 587          // è·å–ç´¯è®¡æµé‡
 588          unsigned long FlowMeter_GetTotalFlow(void) {
 589   1          return totalFlow;
 590   1      }
 591          
 592          // å¤–éƒ¨ä¸­æ–­0æœåŠ¡å‡½æ•° - ç”¨äºè„‰å†²è®¡æ•°
 593          void INT0_ISR() interrupt 0 {
 594   1          // ç®€å•è®¡æ•°ï¼Œæ¯æ¬¡ä¸‹é™æ²¿ä¸­æ–­å¢åŠ è®¡æ•°
 595   1          // å¦‚æœè¿™é‡Œè¢«è°ƒç”¨å¤ªé¢‘ç¹ï¼Œå¯èƒ½æ˜¯ï¼š
 596   1          // 1. T0é¢‘ç‡è¿‡é«˜
 597   1          // 2. ç»§ç”µå™¨è§¦ç‚¹æŠ–åŠ¨
 598   1          // 3. ä¿¡å·å™ªå£°
C51 COMPILER V9.54   FLOWMETER                                                             05/27/2025 21:42:52 PAGE 11  

 599   1          pulseCount++;  // æ¯æ¬¡ä¸­æ–­å¢åŠ è„‰å†²è®¡æ•°
 600   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1073    ----
   CONSTANT SIZE    =     21    ----
   XDATA SIZE       =      4    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      9      52
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
