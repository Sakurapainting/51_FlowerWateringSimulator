C51 COMPILER V9.54   KEYBOARD_CONTROL                                                      05/26/2025 21:55:48 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE KEYBOARD_CONTROL
OBJECT MODULE PLACED IN .\Objects\keyboard_control.obj
COMPILER INVOKED BY: D:\Keil5\C51\BIN\C51.EXE keyboard_control.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Lis
                    -tings\keyboard_control.lst) OBJECT(.\Objects\keyboard_control.obj)

line level    source

   1          #include "keyboard_control.h"
   2          #include "relay.h"
   3          #include "flowmeter.h"
   4          #include "i2c.h"  // 添加I2C头文件
   5          
   6          // 定时浇水配置 - 默认值：6:00:01开始，浇100毫升
   7          TimedWatering timed_watering = {0, 6, 0, 1, 100, 0, 0, 0};
   8          
   9          // 显示模式：0=时钟，1=自动浇水参数
  10          BYTE auto_display_mode = DISPLAY_MODE_CLOCK;
  11          
  12          // 参数设置模式：0=开始小时，1=开始分钟，2=开始秒，3=浇水毫升数
  13          BYTE param_mode = PARAM_MODE_HOUR;  // 修正：使用PARAM_MODE_HOUR而不是PARAM_MODE_INTERVAL
  14          
  15          // 显示更新标志
  16          bit display_update_flag = 0;
  17          
  18          // 按键状态记录（用于消抖）
  19          static BYTE key_prev_state = 0;
  20          
  21          // 按键延时消抖
  22          static void KeyDelay(void) {
  23   1          BYTE i = 30;
  24   1          while(i--);
  25   1      }
  26          
  27          // 初始化按键控制
  28          void KeyboardControl_Init(void) {
  29   1          // 设置按键引脚为输入（上拉）
  30   1          P1 |= 0xFC;  // P1.2-P1.7设为高电平（输入模式）
  31   1          
  32   1          // 初始化I2C和24C02
  33   1          I2C_Init();
  34   1          
  35   1          // 初始化定时浇水参数为默认值
  36   1          timed_watering.enabled = 0;
  37   1          timed_watering.start_hour = 6;      // 默认6点
  38   1          timed_watering.start_min = 0;       // 0分
  39   1          timed_watering.start_sec = 1;       // 1秒开始浇水
  40   1          timed_watering.water_volume_ml = 100; // 浇水100毫升
  41   1          timed_watering.is_watering = 0;
  42   1          timed_watering.watering_volume_left = 0;
  43   1          timed_watering.triggered_today = 0;
  44   1          
  45   1          // 💡 关键修改：启动时自动从24C02加载定时浇水参数
  46   1          TimedWatering_LoadParams();
  47   1          
  48   1          auto_display_mode = DISPLAY_MODE_CLOCK;
  49   1          param_mode = PARAM_MODE_HOUR;
  50   1      }
  51          
  52          /*
  53           * ========================================
  54           * 定时定量浇花功能详细使用说明
C51 COMPILER V9.54   KEYBOARD_CONTROL                                                      05/26/2025 21:55:48 PAGE 2   

  55           * ========================================
  56           * 
  57           * 功能概述：
  58           * 本系统可以设置在指定时间点自动开始浇水，并按设定的毫升数定量浇水。
  59           * 累计流量数据保存在24C02中，掉电不丢失。
  60           * 
  61           * 【第一步：参数设置】
  62           * ==================
  63           * 
  64           * 1. 设置开始浇水时间：
  65           *    操作：按P1.7 (KEY_MODE) 切换到时间设置模式
  66           *    显示：数码管右侧显示模式标识符
  67           *    
  68           *    a) 设置小时：
  69           *       - 数码管显示格式："HH0003" (例如："060003"表示6点)
  70           *       - 按P1.3 (KEY_TIME_UP) 增加小时 (0-23)
  71           *       - 按P1.4 (KEY_TIME_DOWN) 减少小时
  72           *       - 右侧显示"03"表示当前在设置小时
  73           *    
  74           *    b) 设置分钟：
  75           *       - 再按P1.7切换到分钟设置
  76           *       - 数码管显示格式："MM0002" (例如："000002"表示0分)
  77           *       - 按P1.3/P1.4调节分钟数 (0-59)
  78           *       - 右侧显示"02"表示当前在设置分钟
  79           *    
  80           *    c) 设置秒：
  81           *       - 再按P1.7切换到秒设置
  82           *       - 数码管显示格式："SS0001" (例如："010001"表示1秒)
  83           *       - 按P1.3/P1.4调节秒数 (0-59)
  84           *       - 右侧显示"01"表示当前在设置秒
  85           * 
  86           * 2. 设置浇水量：
  87           *    - 再按P1.7切换到毫升设置
  88           *    - 数码管显示格式："MMMM05" (例如："010005"表示100毫升)
  89           *    - 按P1.3 (KEY_TIME_UP) 增加毫升数，每次+50ml
  90           *    - 按P1.4 (KEY_TIME_DOWN) 减少毫升数，每次-50ml
  91           *    - 范围：50-9999毫升
  92           *    - 右侧显示"05"表示当前在设置毫升数
  93           * 
  94           * 【第二步：启动定时浇水】
  95           * ====================
  96           * 
  97           * 操作：按P1.2 (KEY_AUTO) 启动定时浇水功能
  98           * 结果：系统进入定时浇水模式，等待设定时间到达
  99           * 显示：数码管显示当前设置的参数并闪烁
 100           * 
 101           * 【第三步：系统自动运行】
 102           * ====================
 103           * 
 104           * 1. 等待阶段：
 105           *    - 系统持续监控当前时间
 106           *    - 数码管轮流显示设置的参数
 107           *    - 当到达设定时间点时，自动开始浇水
 108           * 
 109           * 2. 浇水阶段：
 110           *    - 继电器自动闭合，开始浇水
 111           *    - 流量计开始计数脉冲
 112           *    - 数码管显示剩余毫升数："XXXX05"
 113           *    - 每个脉冲代表1毫升水流
 114           * 
 115           * 3. 停止阶段：
 116           *    - 当累计流量达到设定毫升数时
C51 COMPILER V9.54   KEYBOARD_CONTROL                                                      05/26/2025 21:55:48 PAGE 3   

 117           *    - 继电器自动断开，停止浇水
 118           *    - 标记今天已完成浇水，明天同一时间再次触发
 119           * 
 120           * 【第四步：数据保存】
 121           * ==================
 122           * 
 123           * - 累计流量每10秒自动保存到24C02
 124           * - 断电重启后累计流量数据不丢失
 125           * - 定时设置保存在内存中，断电后需重新设置
 126           * 
 127           * 【使用示例】
 128           * ============
 129           * 
 130           * 目标：设置每天早上6:00:01自动浇水100毫升
 131           * 
 132           * 操作步骤：
 133           * 1. 按P1.7，显示"060003" → 用P1.3/P1.4设置为6点
 134           * 2. 按P1.7，显示"000002" → 用P1.3/P1.4设置为0分
 135           * 3. 按P1.7，显示"010001" → 用P1.3/P1.4设置为1秒
 136           * 4. 按P1.7，显示"010005" → 用P1.3/P1.4设置为100毫升
 137           * 5. 按P1.2启动定时浇水
 138           * 6. 系统将在每天6:00:01自动浇水100毫升
 139           * 
 140           * 【停止定时浇水】
 141           * ==============
 142           * 
 143           * 操作：再次按P1.2 (KEY_AUTO)
 144           * 结果：停止定时浇水功能，返回时钟显示模式
 145           * 
 146           * 【注意事项】
 147           * ============
 148           * 
 149           * 1. 每天只触发一次，避免重复浇水
 150           * 2. 如果当天已经浇过水，不会再次触发
 151           * 3. 过了午夜(00:00:00)会重置触发标志
 152           * 4. 手动浇水不影响定时浇水功能
 153           * 5. 定时浇水进行中时，手动按键无效
 154           */
 155          
 156          // 按键扫描
 157          void KeyboardControl_Scan(void) {
 158   1          BYTE current_keys = 0;
 159   1          BYTE key_pressed;
 160   1          bit param_changed = 0;  // 参数修改标志
 161   1          
 162   1          // 读取当前按键状态
 163   1          if(KEY_AUTO == 0) current_keys |= 0x01;
 164   1          if(KEY_TIME_UP == 0) current_keys |= 0x02;
 165   1          if(KEY_TIME_DOWN == 0) current_keys |= 0x04;
 166   1          if(KEY_VOL_UP == 0) current_keys |= 0x08;
 167   1          if(KEY_VOL_DOWN == 0) current_keys |= 0x10;
 168   1          if(KEY_MODE == 0) current_keys |= 0x20;
 169   1          
 170   1          // 检测按键按下（下降沿）
 171   1          key_pressed = (~key_prev_state) & current_keys;
 172   1          
 173   1          if(key_pressed & 0x01) {  // KEY_AUTO按下
 174   2              KeyDelay();
 175   2              if(KEY_AUTO == 0) {
 176   3                  if(timed_watering.enabled) {
 177   4                      TimedWatering_Stop();
 178   4                      auto_display_mode = DISPLAY_MODE_CLOCK;
C51 COMPILER V9.54   KEYBOARD_CONTROL                                                      05/26/2025 21:55:48 PAGE 4   

 179   4                      FillDispBuf(SysPara1.hour, SysPara1.min, SysPara1.sec);
 180   4                      display_update_flag = 1;
 181   4                  } else {
 182   4                      TimedWatering_Start();
 183   4                  }
 184   3              }
 185   2          }
 186   1          
 187   1          if(key_pressed & 0x20) {  // KEY_MODE按下
 188   2              KeyDelay();
 189   2              if(KEY_MODE == 0) {
 190   3                  param_mode = (param_mode + 1) % 4;  // 4个参数模式
 191   3                  auto_display_mode = DISPLAY_MODE_AUTO;
 192   3                  display_update_flag = 1;
 193   3              }
 194   2          }
 195   1          
 196   1          if(key_pressed & 0x02) {  // KEY_TIME_UP按下
 197   2              KeyDelay();
 198   2              if(KEY_TIME_UP == 0) {
 199   3                  switch(param_mode) {
 200   4                      case PARAM_MODE_HOUR:
 201   4                          timed_watering.start_hour = (timed_watering.start_hour + 1) % 24;
 202   4                          param_changed = 1;
 203   4                          break;
 204   4                      case PARAM_MODE_MIN:
 205   4                          timed_watering.start_min = (timed_watering.start_min + 1) % 60;
 206   4                          param_changed = 1;
 207   4                          break;
 208   4                      case PARAM_MODE_SEC:
 209   4                          timed_watering.start_sec = (timed_watering.start_sec + 1) % 60;
 210   4                          param_changed = 1;
 211   4                          break;
 212   4                      case PARAM_MODE_VOLUME:
 213   4                          if(timed_watering.water_volume_ml < 9950) {
 214   5                              timed_watering.water_volume_ml += 50;
 215   5                              param_changed = 1;
 216   5                          }
 217   4                          break;
 218   4                  }
 219   3                  auto_display_mode = DISPLAY_MODE_AUTO;
 220   3                  display_update_flag = 1;
 221   3              }
 222   2          }
 223   1          
 224   1          if(key_pressed & 0x04) {  // KEY_TIME_DOWN按下
 225   2              KeyDelay();
 226   2              if(KEY_TIME_DOWN == 0) {
 227   3                  switch(param_mode) {
 228   4                      case PARAM_MODE_HOUR:
 229   4                          timed_watering.start_hour = (timed_watering.start_hour == 0) ? 23 : (timed_watering.st
             -art_hour - 1);
 230   4                          param_changed = 1;
 231   4                          break;
 232   4                      case PARAM_MODE_MIN:
 233   4                          timed_watering.start_min = (timed_watering.start_min == 0) ? 59 : (timed_watering.star
             -t_min - 1);
 234   4                          param_changed = 1;
 235   4                          break;
 236   4                      case PARAM_MODE_SEC:
 237   4                          timed_watering.start_sec = (timed_watering.start_sec == 0) ? 59 : (timed_watering.star
             -t_sec - 1);
C51 COMPILER V9.54   KEYBOARD_CONTROL                                                      05/26/2025 21:55:48 PAGE 5   

 238   4                          param_changed = 1;
 239   4                          break;
 240   4                      case PARAM_MODE_VOLUME:
 241   4                          if(timed_watering.water_volume_ml > 50) {
 242   5                              timed_watering.water_volume_ml -= 50;
 243   5                              param_changed = 1;
 244   5                          }
 245   4                          break;
 246   4                  }
 247   3                  auto_display_mode = DISPLAY_MODE_AUTO;
 248   3                  display_update_flag = 1;
 249   3              }
 250   2          }
 251   1          
 252   1          // 💡 关键新增：参数修改后立即保存
 253   1          if(param_changed) {
 254   2              TimedWatering_SaveParams();
 255   2          }
 256   1          
 257   1          key_prev_state = current_keys;
 258   1      }
 259          
 260          // 启动定时浇水
 261          void TimedWatering_Start(void) {
 262   1          timed_watering.enabled = 1;
 263   1          timed_watering.is_watering = 0;
 264   1          timed_watering.triggered_today = 0;  // 重置触发标志
 265   1          
 266   1          // 💡 立即保存参数到24C02
 267   1          TimedWatering_SaveParams();
 268   1          
 269   1          // 启动后立即返回时钟显示模式，而不是显示参数
 270   1          auto_display_mode = DISPLAY_MODE_CLOCK;
 271   1          display_update_flag = 1;  // 设置标志立即更新显示
 272   1          
 273   1          // 强制更新时钟显示
 274   1          FillDispBuf(SysPara1.hour, SysPara1.min, SysPara1.sec);
 275   1      }
 276          
 277          // 停止定时浇水
 278          void TimedWatering_Stop(void) {
 279   1          timed_watering.enabled = 0;
 280   1          timed_watering.triggered_today = 0;
 281   1          
 282   1          // 如果正在浇水，立即停止
 283   1          if(timed_watering.is_watering) {
 284   2              timed_watering.is_watering = 0;
 285   2              Relay_Off();
 286   2              FlowMeter_Stop();
 287   2              FlowMeter_SetMode(FLOW_MODE_OFF);
 288   2          }
 289   1          
 290   1          // 💡 立即保存参数到24C02
 291   1          TimedWatering_SaveParams();
 292   1      }
 293          
 294          // 更新定时浇水状态（每秒调用一次）
 295          void TimedWatering_Update(void) {
 296   1          unsigned long current_total_flow;
 297   1          static unsigned long start_total_flow = 0;
 298   1          unsigned long watered_volume;
 299   1          
C51 COMPILER V9.54   KEYBOARD_CONTROL                                                      05/26/2025 21:55:48 PAGE 6   

 300   1          if(!timed_watering.enabled) return;
 301   1          
 302   1          if(timed_watering.is_watering) {
 303   2              // 正在浇水，检查累计流量是否达到目标
 304   2              current_total_flow = FlowMeter_GetTotalFlow();
 305   2              watered_volume = current_total_flow - start_total_flow;
 306   2              
 307   2              if(watered_volume >= timed_watering.water_volume_ml) {
 308   3                  // 达到目标毫升数，停止浇水
 309   3                  timed_watering.is_watering = 0;
 310   3                  timed_watering.triggered_today = 1;  // 标记今天已触发
 311   3                  
 312   3                  Relay_Off();
 313   3                  FlowMeter_Stop();
 314   3                  FlowMeter_SetMode(FLOW_MODE_OFF);
 315   3                  
 316   3                  // 保存累计流量到24C02
 317   3                  AT24C02_WriteTotalFlow(current_total_flow);
 318   3                  
 319   3                  // 浇水完成后返回时钟显示
 320   3                  auto_display_mode = DISPLAY_MODE_CLOCK;
 321   3                  FillDispBuf(SysPara1.hour, SysPara1.min, SysPara1.sec);
 322   3                  display_update_flag = 1;
 323   3              } else {
 324   3                  // 更新剩余毫升数显示
 325   3                  timed_watering.watering_volume_left = timed_watering.water_volume_ml - watered_volume;
 326   3                  if(auto_display_mode != DISPLAY_MODE_AUTO) {
 327   4                      auto_display_mode = DISPLAY_MODE_AUTO;
 328   4                      display_update_flag = 1;
 329   4                  }
 330   3              }
 331   2          } else {
 332   2              // 💡 核心逻辑：每天检查是否到达设定时间点
 333   2              if(!timed_watering.triggered_today &&
 334   2                 SysPara1.hour == timed_watering.start_hour &&
 335   2                 SysPara1.min == timed_watering.start_min &&
 336   2                 SysPara1.sec == timed_watering.start_sec) {
 337   3                  
 338   3                  // 开始浇水 - 每天在设定时间自动触发
 339   3                  timed_watering.is_watering = 1;
 340   3                  timed_watering.watering_volume_left = timed_watering.water_volume_ml;
 341   3                  start_total_flow = FlowMeter_GetTotalFlow();
 342   3                  
 343   3                  Relay_On();
 344   3                  FlowMeter_Start();
 345   3                  FlowMeter_SetMode(FLOW_MODE_CURR);
 346   3                  
 347   3                  auto_display_mode = DISPLAY_MODE_AUTO;
 348   3                  display_update_flag = 1;
 349   3              }
 350   2              
 351   2              // 💡 关键机制：午夜重置，确保每天都能触发
 352   2              // 当时钟走到00:00:00时，重置今日触发标志
 353   2              // 这样明天同一时间又可以触发浇水了
 354   2              if(timed_watering.triggered_today && 
 355   2                 SysPara1.hour == 0 && SysPara1.min == 0 && SysPara1.sec == 0) {
 356   3                  timed_watering.triggered_today = 0;  // 重置标志，准备明天的触发
 357   3              }
 358   2          }
 359   1      }
 360          
 361          // 显示自动浇水参数
C51 COMPILER V9.54   KEYBOARD_CONTROL                                                      05/26/2025 21:55:48 PAGE 7   

 362          void DisplayAutoWateringParams(void) {
 363   1          BYTE val1, val2, val3, val4, val5, val6;
 364   1          
 365   1          if(timed_watering.is_watering) {
 366   2              // 显示剩余毫升数
 367   2              val1 = timed_watering.watering_volume_left % 10;
 368   2              val2 = (timed_watering.watering_volume_left / 10) % 10;
 369   2              val3 = (timed_watering.watering_volume_left / 100) % 10;
 370   2              val4 = (timed_watering.watering_volume_left / 1000) % 10;
 371   2              val5 = 0;  // 显示0
 372   2              val6 = 5;  // 显示5（剩余毫升标识）
 373   2          } else {
 374   2              // 移除闪烁显示，直接显示当前参数
 375   2              switch(param_mode) {
 376   3                  case PARAM_MODE_HOUR:
 377   3                      // 显示开始小时 "小时数03"
 378   3                      val1 = timed_watering.start_hour % 10;
 379   3                      val2 = (timed_watering.start_hour / 10) % 10;
 380   3                      val3 = 0;
 381   3                      val4 = 0;
 382   3                      val5 = 0;
 383   3                      val6 = 3;  // 显示3（小时标识）
 384   3                      break;
 385   3                      
 386   3                  case PARAM_MODE_MIN:
 387   3                      // 显示开始分钟 "分钟数02"
 388   3                      val1 = timed_watering.start_min % 10;
 389   3                      val2 = (timed_watering.start_min / 10) % 10;
 390   3                      val3 = 0;
 391   3                      val4 = 0;
 392   3                      val5 = 0;
 393   3                      val6 = 2;  // 显示2（分钟标识）
 394   3                      break;
 395   3                      
 396   3                  case PARAM_MODE_SEC:
 397   3                      // 显示开始秒 "秒数01"
 398   3                      val1 = timed_watering.start_sec % 10;
 399   3                      val2 = (timed_watering.start_sec / 10) % 10;
 400   3                      val3 = 0;
 401   3                      val4 = 0;
 402   3                      val5 = 0;
 403   3                      val6 = 1;  // 显示1（秒标识）
 404   3                      break;
 405   3                      
 406   3                  case PARAM_MODE_VOLUME:
 407   3                      // 显示浇水毫升数 "毫升数05"
 408   3                      val1 = timed_watering.water_volume_ml % 10;
 409   3                      val2 = (timed_watering.water_volume_ml / 10) % 10;
 410   3                      val3 = (timed_watering.water_volume_ml / 100) % 10;
 411   3                      val4 = (timed_watering.water_volume_ml / 1000) % 10;
 412   3                      val5 = 0;
 413   3                      val6 = 5;  // 显示5（毫升标识）
 414   3                      break;
 415   3                      
 416   3                  default:
 417   3                      val1 = val2 = val3 = val4 = val5 = val6 = 0;
 418   3                      break;
 419   3              }
 420   2              
 421   2              // 移除闪烁逻辑，始终显示参数值
 422   2              // if(display_toggle >= 4) {
 423   2              //     val1 = val2 = val3 = val4 = 0;  // 数值部分熄灭
C51 COMPILER V9.54   KEYBOARD_CONTROL                                                      05/26/2025 21:55:48 PAGE 8   

 424   2              // }
 425   2          }
 426   1          
 427   1          FillCustomDispBuf(val1, val2, val3, val4, val5, val6);
 428   1      }
 429          
 430          // 添加缺失的函数：检查并更新自动显示
 431          void CheckAndUpdateAutoDisplay(void) {
 432   1          if(display_update_flag) {
 433   2              display_update_flag = 0;  // 清除标志
 434   2              
 435   2              if(auto_display_mode == DISPLAY_MODE_AUTO) {
 436   3                  DisplayAutoWateringParams();
 437   3              }
 438   2          }
 439   1      }
 440          
 441          // 保存定时浇水参数到24C02
 442          void TimedWatering_SaveParams(void) {
 443   1          AT24C02_WriteTimedWateringParams(&timed_watering);
 444   1      }
 445          
 446          // 从24C02加载定时浇水参数
 447          void TimedWatering_LoadParams(void) {
 448   1          AT24C02_ReadTimedWateringParams(&timed_watering);
 449   1          
 450   1          // 💡 关键修改：保持加载的enabled状态，但重置运行时状态
 451   1          // 如果之前启用了定时浇水，加载后依然保持启用
 452   1          // timed_watering.enabled = timed_watering.enabled;  // 保持原值
 453   1          
 454   1          // 重置运行时状态
 455   1          timed_watering.is_watering = 0;
 456   1          timed_watering.watering_volume_left = 0;
 457   1          
 458   1          // 💡 重要：检查是否需要重置今日触发标志
 459   1          // 如果系统重启，应该允许今天再次触发（除非今天已经过了设定时间）
 460   1          if(timed_watering.enabled) {
 461   2              // 如果当前时间已经超过了设定时间，标记为今日已触发
 462   2              if(SysPara1.hour > timed_watering.start_hour || 
 463   2                 (SysPara1.hour == timed_watering.start_hour && SysPara1.min > timed_watering.start_min) ||
 464   2                 (SysPara1.hour == timed_watering.start_hour && SysPara1.min == timed_watering.start_min && SysP
             -ara1.sec > timed_watering.start_sec)) {
 465   3                  timed_watering.triggered_today = 1;  // 今天的浇水时间已过
 466   3              } else {
 467   3                  timed_watering.triggered_today = 0;  // 今天的浇水时间还没到
 468   3              }
 469   2          }
 470   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1042    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     17      16
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
