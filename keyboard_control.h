#ifndef KEYBOARD_CONTROL_H
#define KEYBOARD_CONTROL_H

#include "reg51.h"
#include "pca.h"
#include "uart.h"  // 添加uart.h以使用WateringRecord结构

/*
 * ========================================
 * 定时定量浇花功能 - 按键操作指南
 * ========================================
 * 
 * 【按键布局】
 * ============
 * 
 *   P1.2        P1.3        P1.4        P1.7
 * ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐
 * │ AUTO │   │  ▲   │   │  ▼   │   │ MODE │
 * │启动  │   │ 增加  │   │ 减少  │   │ 模式 │
 * │停止  │   │      │   │      │   │ 切换 │
 * └──────┘   └──────┘   └──────┘   └──────┘
 * 
 * 【按键功能详解】
 * ================
 * 
 * 🔘 P1.2 (KEY_AUTO) - 启动/停止按键
 *    ┌─────────────────────────────────────┐
 *    │ 功能：启动或停止定时浇水功能         │
 *    │ 按一次：启动定时浇水，进入参数显示   │
 *    │ 再按一次：停止定时浇水，返回时钟显示 │
 *    │ 注意：如果正在浇水，会立即停止       │
 *    └─────────────────────────────────────┘
 * 
 * 🔘 P1.7 (KEY_MODE) - 模式切换按键  
 *    ┌─────────────────────────────────────┐
 *    │ 功能：在4种参数设置模式间循环切换    │
 *    │ 模式0：小时设置 (显示HH0003)        │
 *    │ 模式1：分钟设置 (显示MM0002)        │
 *    │ 模式2：秒设置   (显示SS0001)        │
 *    │ 模式3：毫升设置 (显示MMMM05)        │
 *    └─────────────────────────────────────┘
 * 
 * 🔘 P1.3 (KEY_TIME_UP) - 数值增加按键
 *    ┌─────────────────────────────────────┐
 *    │ 功能：增加当前选择参数的数值         │
 *    │ 小时模式：+1小时 (0→1→...→23→0)    │
 *    │ 分钟模式：+1分钟 (0→1→...→59→0)    │
 *    │ 秒模式：  +1秒   (0→1→...→59→0)    │
 *    │ 毫升模式：+50毫升 (50→100→150...)   │
 *    └─────────────────────────────────────┘
 * 
 * 🔘 P1.4 (KEY_TIME_DOWN) - 数值减少按键
 *    ┌─────────────────────────────────────┐
 *    │ 功能：减少当前选择参数的数值         │
 *    │ 小时模式：-1小时 (23←22←...←0←23)   │
 *    │ 分钟模式：-1分钟 (59←58←...←0←59)   │
 *    │ 秒模式：  -1秒   (59←58←...←0←59)   │
 *    │ 毫升模式：-50毫升 (...←150←100←50)  │
 *    └─────────────────────────────────────┘
 * 
 * 【操作流程图】
 * ==============
 * 
 *      开始
 *       │
 *   ┌───▼────┐
 *   │ 按P1.7 │ 
 *   │选择模式│
 *   └───┬────┘
 *       │
 *   ┌───▼────┐     ┌─────────┐
 *   │小时设置│────▶│用P1.3/4 │
 *   │HH0003 │     │调节小时 │
 *   └───┬────┘     └─────────┘
 *       │ P1.7
 *   ┌───▼────┐     ┌─────────┐
 *   │分钟设置│────▶│用P1.3/4 │
 *   │MM0002 │     │调节分钟 │
 *   └───┬────┘     └─────────┘
 *       │ P1.7
 *   ┌───▼────┐     ┌─────────┐
 *   │秒设置  │────▶│用P1.3/4 │
 *   │SS0001 │     │调节秒   │
 *   └───┬────┘     └─────────┘
 *       │ P1.7
 *   ┌───▼────┐     ┌─────────┐
 *   │毫升设置│────▶│用P1.3/4 │
 *   │MMMM05 │     │调节毫升 │
 *   └───┬────┘     └─────────┘
 *       │
 *   ┌───▼────┐
 *   │ 按P1.2 │
 *   │启动浇水│
 *   └───┬────┘
 *       │
 *   ┌───▼────┐
 *   │ 等待时间│
 *   │自动浇水│
 *   └────────┘
 * 
 * 【参数范围限制】
 * ================
 * 
 * ⏰ 时间参数：
 * - 开始小时：0-23 (24小时制)
 * - 开始分钟：0-59
 * - 开始秒：  0-59
 * 
 * 💧 流量参数：
 * - 浇水毫升数：50-9999毫升
 * - 调节步长：50毫升
 * - 建议范围：100-500毫升
 * 
 * 【设置技巧】
 * ============
 * 
 * 💡 快速设置时间：
 * - 连续按P1.3快速增加数值
 * - 从大到小用P1.4更快到达目标值
 * 
 * 💡 毫升数设置：
 * - 常用量：100ml(P1.3按2次)
 * - 常用量：200ml(P1.3按4次)
 * - 最大值：从50开始按P1.3多次
 * 
 * 💡 确认设置：
 * - 设置完成后按P1.2立即启动
 * - 观察数码管闪烁确认进入等待模式
 */

/*
 * ========================================
 * 定时定量浇花功能使用说明（新版本）
 * ========================================
 * 
 * 1. 按键功能说明：
 *    - P1.2 (KEY_AUTO): 启动/停止定时浇水功能
 *    - P1.3 (KEY_TIME_UP): 增加当前选择参数的数值
 *    - P1.4 (KEY_TIME_DOWN): 减少当前选择参数的数值
 *    - P1.7 (KEY_MODE): 切换参数设置模式
 * 
 * 2. 参数设置模式：
 *    模式0 - 开始小时设置 (PARAM_MODE_HOUR) - 显示标识"03"
 *    模式1 - 开始分钟设置 (PARAM_MODE_MIN) - 显示标识"02"
 *    模式2 - 开始秒设置 (PARAM_MODE_SEC) - 显示标识"01"
 *    模式3 - 浇水毫升数设置 (PARAM_MODE_VOLUME) - 显示标识"05"
 * 
 * 3. 使用步骤：
 *    步骤1: 按P1.7切换到小时设置，设置开始浇水的小时 (显示HH0003)
 *    步骤2: 按P1.7切换到分钟设置，设置开始浇水的分钟 (显示MM0002)
 *    步骤3: 按P1.7切换到秒设置，设置开始浇水的秒 (显示SS0001)
 *    步骤4: 按P1.7切换到毫升设置，设置需要浇水的毫升数 (显示MMMM05)
 *    步骤5: 按P1.2启动定时浇水功能
 * 
 * 4. 参数范围：
 *    - 开始小时：0-23小时
 *    - 开始分钟：0-59分钟
 *    - 开始秒：0-59秒
 *    - 浇水毫升数：50-9999毫升 (步长50毫升)
 * 
 * 5. 工作原理：
 *    - 系统监控当前时间，当到达设定时间点时自动开始浇水
 *    - 浇水过程中监控累计流量，达到设定毫升数时自动停止
 *    - 每天只触发一次，次日同一时间再次触发
 *    - 累计流量数据保存在24C02中，掉电不丢失
 */

// 按键定义 - 使用P1口的其他引脚
sbit KEY_AUTO = P1^2;         // 启动/停止定时浇水
sbit KEY_TIME_UP = P1^3;      // 增加浇水时间
sbit KEY_TIME_DOWN = P1^4;    // 减少浇水时间
sbit KEY_VOL_UP = P1^5;       // 增加浇水毫升数
sbit KEY_VOL_DOWN = P1^6;     // 减少浇水毫升数
sbit KEY_MODE = P1^7;         // 切换参数设置模式

// 定时浇水配置结构
typedef struct TimedWatering {
    unsigned char enabled;              // 是否启用定时浇水
    unsigned char start_hour;           // 开始浇水的小时
    unsigned char start_min;            // 开始浇水的分钟
    unsigned char start_sec;            // 开始浇水的秒
    unsigned int water_volume_ml;       // 单次浇水毫升数
    unsigned char is_watering;          // 是否正在浇水
    unsigned int watering_volume_left;  // 剩余浇水毫升数
    unsigned char triggered_today;      // 今天是否已经触发过
    // 新增：浇水记录相关字段
    unsigned long start_total_flow;     // 开始时的累计流量
    WateringRecord current_record;      // 当前浇水记录
} TimedWatering;

// 参数设置模式定义
#define PARAM_MODE_HOUR      0    // 设置开始小时
#define PARAM_MODE_MIN       1    // 设置开始分钟
#define PARAM_MODE_SEC       2    // 设置开始秒
#define PARAM_MODE_VOLUME    3    // 设置浇水毫升数

// 显示模式定义
#define DISPLAY_MODE_CLOCK    0    // 时钟显示模式
#define DISPLAY_MODE_AUTO     1    // 自动浇水参数显示模式

// 全局变量声明
extern TimedWatering xdata timed_watering;  // 更新为xdata声明
extern unsigned char auto_display_mode;
extern unsigned char param_mode;
extern bit display_update_flag;  // 添加显示更新标志

// 新增：手动浇水记录变量
extern WateringRecord xdata manual_watering_record;

// 函数声明
void KeyboardControl_Init(void);
void KeyboardControl_Scan(void);
void TimedWatering_Update(void);
void TimedWatering_Start(void);
void TimedWatering_Stop(void);
void DisplayAutoWateringParams(void);
void CheckAndUpdateAutoDisplay(void);

// 优化后的浇水记录相关函数 - 避免传参
void StartManualWateringRecord(void);     // 开始手动浇水记录
void EndManualWateringRecord(void);       // 结束手动浇水记录
void StartAutoWateringRecord(void);       // 开始自动浇水记录
void EndAutoWateringRecord(void);         // 结束自动浇水记录

#endif
